<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Example</title>
  <!--<link rel="stylesheet" type="text/css" href="styles.css"> -->
  <script src="../socket.io/socket.io.js"></script>
  <script type="text/javascript">
    curl = {
      packages: {
        'ground': {
          path: '../dist/',
          main: 'gnd',
          lib: ''
        },
      },
      paths : {
        jquery : 'http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min',
        underscore : 'https://raw.github.com/amdjs/underscore/master/underscore-min'
      }
    };
  </script>
  
  <script src="https://raw.github.com/cujojs/curl/master/dist/curl-kitchen-sink/curl.js"></script>
  <script>

    localStorage.clear();
    curl(['jquery', 'underscore'], function($,_){
      curl(['ground'], function(gnd){
        var socket = io.connect();
        socket.once('connect', function(){
          var storageLocal  = new Gnd.Storage.Local();
          var storageSocket = new Gnd.Storage.Socket(socket);

          var storageQueue  = new Gnd.Storage.Queue(storageLocal, storageSocket);

          var syncManager = new Gnd.Sync.Manager(socket);

          Gnd.Model.storageQueue = storageQueue;
          Gnd.Model.syncManager = syncManager;

          var Chat = Gnd.Model.extend('Chat');

          storageQueue.init(function(){
            var chat = new Chat();
            chat.keepSynced();
          })
          $('#submit').click(function() {
            chat = new Chat();
            chat.keepSynced();

            chat.save(function(err){
              storageQueue.once('created:'+chat.id(), function(sid){
                // get an absolute url to the room
                var url = window.location.protocol + '//' +
                  window.location.host + '/chat/room.html#/' + chat.id();

                $('#link').append('<li><a href="' + url + '" target="_blank">' + url + '</a></li>');
              });
            });
          });
        }); 
      });
    });
  </script>
</head>
<body>
  <input id="submit" type="submit" value="Create new Chat Room"></input>
  <ul id="link"></ul>
</body>
</html>
