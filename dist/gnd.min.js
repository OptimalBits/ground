var Gnd;(function(t){(function(t){function e(){}function n(t,e){t||console.log("Assert failed:%s",e)}function i(t,e){for(e=t="";36>t++;e+=52&51*t?(15^t?8^Math.random()*(20^t?16:4):4).toString(16):"-");return e}function o(){window.location.replace("")}function r(t){var e=_.isArray(t)?t:arguments;_.each(e,function(t){t&&t.retain()})}function s(t){var e=_.isArray(t)?t:arguments;_.each(e,function(t){t&&t.release()})}function a(t){setTimeout(t,0)}function u(){return this.replace(/^\s+|\s+$/g,"")}function c(t){var e=null,n=null;return function(){var i=this,o=arguments,r=o.length,s=o[r-1],a=function(){n=t,t.apply(i,o)};o[r-1]=function(){if(s.apply(i,arguments),n=null,e){var t=e;e=null,t()}},n?e=a:a()}}function h(t,e,n,i){return function(){var o=this,r=!1,s=null,a=Array.prototype.slice.call(arguments),u=a.length,c=a[u-1];a[u-1]=function(){clearTimeout(s),r&&n(),c.apply(o,arguments)},s=setTimeout(function(){r=!0,e()},i),t.apply(this,a)}}function d(t,e,n){if(e){var i=!1;e=e.toLowerCase();for(var o=0,r=n.length;r>o;o++)-1!=(t[n[o]]+"").toLowerCase().indexOf(e)&&(i=!0);return i}return!0}function f(t,n,i){function o(t,o){n(t,function(t){t?(i&&i(t),i=e):(r++,r===o&&i&&i(null))})}var r=0;if(_.isArray(t))if(0===t.length)i&&i(null);else for(var s=0,a=t.length;a>s;s++)o(t[s],a);else o(t,1)}function p(t,n,i){function o(){n(t[r],function(n){n?(i(n),i=e):(r++,t.length>r?o():i())})}if(i=i||e,!t.length)return i();var r=0;o()}function l(t,e){function n(){this.constructor=o}var i,o=function(){t.apply(this,arguments)};return e&&(i=e(t.prototype),o=i.constructor),n.prototype=t.prototype,o.prototype=new n,_.extend(o.prototype,i),o}function y(t){function e(){r(Error("Socket disconnected"))}function n(n,i){t.removeListener("disconnect",e),n&&(n=Error(n)),r(n,i)}for(var i=[],o=0;arguments.length-1>o;o++)i[o]=arguments[o+1];var r=_.last(i);i[i.length-1]=n,t.socket.connected?(t.once("disconnect",e),t.emit.apply(t,i)):e()}t.noop=e,t.assert=n,t.uuid=i,t.refresh=o,t.retain=r,t.release=s,t.nextTick=a,t.trim=u,t.asyncDebounce=c,t.waitTrigger=h,t.searchFilter=d,t.asyncForEach=f,t.asyncForEachSeries=p,t.extend=l;var v=function(t,e,n,i){return i=_.isFunction(n)?n:i,n=_.isFunction(n)?void 0:JSON.stringify(n),{type:t,url:e,data:n,contentType:"application/json",dataType:"json",success:function(t){i(null,t)},error:function(t){i(t)}}};t.ajax={get:function(t,e,n){return $.ajax(v("GET",t,e,n))},put:function(t,e,n){return $.ajax(v("PUT",t,e,n))},post:function(t,e,n){return $.ajax(v("POST",t,e,n))},del:function(t,e,n){return $.ajax(v("DELETE",t,e,n))}},t.safeEmit=y})(t.Util||(t.Util={})),t.Util})(Gnd||(Gnd={}));var Gnd;(function(t){function e(t){return function(){for(var e=[],i=0;arguments.length-0>i;i++)e[i]=arguments[i+0];var o="";if(e.length){_.isUndefined(e[0])||(o+=n(e[0]));for(var r=1;e.length>r;r++)_.isUndefined(e[r])||(o+=" "+n(e[r]))}if(t[o])return t[o].apply(this,e);throw Error("Not matched function signature: "+o)}}function n(t){var e;return t&&t.getName?t.getName():(e=Object.prototype.toString.call(t),e.slice(8,e.length-1))}t.overload=e})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(){function t(){this.tasks=[],this.endPromise=new n}return t.prototype.append=function(){for(var t=[],e=0;arguments.length-0>e;e++)t[e]=arguments[e+0];if(this.isEnded)throw Error("TaskQueue already ended");return this.tasks.push.apply(this.tasks,_.compact(t)),this.executeTasks(),this},t.prototype.cancel=function(){this.isCancelled=!0},t.prototype.end=function(){return this.isEnded=!0,this.isExecuting||this.endPromise.resolve(),this},t.prototype.wait=function(t){this.endPromise.then(t)},t.prototype.executeTasks=function(){var t=this;if(this.tasks.length>0&&!this.isCancelled&&!this.isExecuting){this.isExecuting=!0;var e=this.tasks.splice(0,1)[0];e(function(){t.isExecuting=!1,t.executeTasks()})}else(this.isEnded||this.isCancelled)&&this.endPromise.resolve(this.isCancelled)},t}();t.TaskQueue=e;var n=function(){function t(){this.callbacks=[]}return t.prototype.then=function(t){this.resolved?this.fire(t):this.callbacks.push(t)},t.prototype.resolve=function(){for(var t=[],e=0;arguments.length-0>e;e++)t[e]=arguments[e+0];this.isAborted||(this.resolved=t,this.fireCallbacks())},t.prototype.abort=function(){this.isAborted=!0},t.prototype.fire=function(t){t.apply(this,this.resolved)},t.prototype.fireCallbacks=function(){var t=this.callbacks.length;if(t>0)for(var e=0;t>e;e++)this.fire(this.callbacks[e])},t}();t.Promise=n;var i=function(){function e(){for(var t=[],e=0;arguments.length-0>e;e++)t[e]=arguments[e+0];this.promises=t}return e.prototype.abort=function(){_.invoke(this.promises,"abort")},e.prototype.then=function(e){t.Util.asyncForEachSeries(this.promises,function(t,e){t&&t.then(e)},e)},e}();t.PromiseQueue=i})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(){function t(){}return t.prototype.getListeners=function(){return this._listeners=this._listeners||{},this._listeners},t.prototype.getNamespaces=function(){return this._namespaces=this._namespaces||{},this._namespaces},t.prototype.on=function(t,e){for(var n=t.split(" "),i=this.getListeners(),o=0,r=n.length;r>o;o++){var s,a,u=n[o].split("/");if(u.length>1?(a=u[0],s=u[1]):(a=null,s=u[0]),i[s]?i[s].push(e):i[s]=[e],a){var c=this.getNamespaces();c[a]=c[a]||{},c[a][s]?c[a][s].push(e):c[a][s]=[e]}this.emit("newListener",s,e)}return this},t.prototype.emit=function(t){for(var e=[],n=0;arguments.length-1>n;n++)e[n]=arguments[n+1];var i=this.getListeners();return i["*"]&&this._fire(i["*"],arguments),i[t]&&this._fire(i[t],e),this},t.prototype.off=function(t,e){if(e)for(var n=t.split(" "),i=0,o=n.length;o>i&&!this._removeListener(n[i],e);i++);else this.removeAllListeners(t);return this},t.prototype.listeners=function(t){var e=this.getListeners();return e[t]=e[t]||[]},t.prototype.once=function(t,e){function n(){i.off(t,n),e.apply(this,arguments)}var i=this;return i.on(t,n)},t.prototype.removeAllListeners=function(t){var e=this._listeners;if(e)if(t)for(var n=t.split(" "),i=0,o=n.length;o>i;i++)this._removeNamespacedEvent(n[i],e);else delete this._listeners;return this},t.prototype.namespace=function(t){var e=this,n={self:e,namespace:t,on:function(t,e){return this.self.on(this.namespace+"/"+t,e),n},off:function(t){var e=this.namespace+"/";return t&&(e+=t),this.self.off(e),n}};return n},t.prototype._fire=function(t,e){var n,i=[],o=t.length;for(n=0;o>n;n++)i[n]=t[n];for(n=0;o>n;n++)i[n].apply(this,e)},t.prototype._removeListener=function(t,e){var n,i=this._listeners;return i&&i[t]&&(n=_.indexOf(i[t],e),-1!==n)?(i[t].splice(n,1),!0):!1},t.prototype._removeNamespacedEvent=function(t,e){var n=this,i=n._namespaces,o=t.split("/");if(1===o.length)t=o[0],e&&delete e[t],i&&delete i[t];else if(i){var r=o[0];if(t=o[1],i[r]){var s;if(""===t){var a=i[r];_.each(a,function(t,e){for(var i=0,o=t.length;o>i;i++)n._removeListener(e,t[i])})}else if(s=_.union(s,i[r][t]))for(var u=0,c=e.length;c>u;u++)this._removeListener(t,s[u])}}},t}();t.EventEmitter=e,e.prototype.addListener=e.prototype.on,e.prototype.addObserver=e.prototype.on,e.prototype.removeListener=e.prototype.off,e.prototype.removeObserver=e.prototype.off})(Gnd||(Gnd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n},Gnd;(function(t){var e=function(t){function e(){t.apply(this,arguments),this.undones=[],this.actions=[],this.undoFn=null,this.group=null}return __extends(e,t),e.prototype.beginUndo=function(t,e){this.undoFn=t,this.name=e},e.prototype.endUndo=function(t,e){this.action(t,this.undoFn,e,this.name),this.undoFn=null},e.prototype.action=function(t,e,n,i){this.undones.length=0,i=_.isString(n)?n:i;var o={"do":t,undo:e,fn:n,name:i};this.group?this.actions.push(o):this.group.push(o),t(n)},e.prototype.beginGroup=function(t){this.group={name:t,actions:[]}},e.prototype.endGroup=function(){(function(t){this.action(function(){for(var e=0,n=t.length;n>e;e++)t[e].action["do"](t[e].action.fn)},function(){for(var e=0,n=t.length;n>e;e++)t[e].action.undo(t[e].action.fn)},function(){},t.name)})(this.group),this.group=null},e.prototype.canUndo=function(){return this.actions.length>0},e.prototype.canRedo=function(){return this.undones.length>0},e.prototype.undo=function(){var t=this.actions.pop();if(t){t.undo(t.fn);var e=t.name||"";this.emit("undo",e),this.undones.push(t)}},e.prototype.redo=function(){var t=this.undones.pop();if(t){t["do"](t.fn);var e=t.name||"";this.emit("redo",e),this.actions.push(t)}},e}(t.EventEmitter);t.UndoManager=e})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(e){function n(){return e.call(this),this._refCounter=1,this._bindings={},this._undoMgr=new t.UndoManager,this instanceof n?void 0:new n}return __extends(n,e),n.prototype._set=function(t,e,i){for(var o=t.split("."),r=this,s=o.length-1,a=o[s],u=0;s>u;u++){var c=this[o[u]];r=c?c:this[o[u]]=new n}if(0==_.isEqual(r[a],e)||i&&i.force){var h=r[a],e=this.willChange?this.willChange(a,e):e;return r[a]=e,this.emit(t,e,h,i),!0}return!1},n.prototype.set=function(t,e,n){var i,o=!1,r=this;return"object"==typeof t?(n=e,i=t,_.each(i,function(t,e){o=r._set(e,t,n)?!0:o})):o=r._set(t,e,n),o&&(i||(i={},i[t]=e),r.emit("changed:",i,n)),this},n.prototype.willChange=function(t,e){return e},n.prototype.get=function(t){var e,n=t.split(".");e=this[n[0]];for(var i=1,o=n.length;o>i&&_.isObject(e);i++)e=e[n[i]];return e},n.prototype.bind=function(t,e,n){var i=n||t;this.unbind(t);var o=_.bind(e.set,e,i);this.on(t,o);var r=_.bind(this.set,this,t);return e.on(i,r),this._bindings[t]=[o,e,i,r],this.set(t,e[i]),this},n.prototype.unbind=function(t){var e=this._bindings;if(null!=e&&e[t]){var n=e[t];this.removeListener(t,n[0]),n[1].removeListener(n[2],n[3]),delete e[t]}},n.prototype.format=function(t,e){if(1==arguments.length){if(!_.isObject(t)){if(this._formatters&&t in this._formatters){var n=this.get(t);return _.isFunction(n)&&(n=n.call(this)),this._formatters[t].call(this,n)}return this.get(t)}this._formatters||(this._formatters={}),_.extend(this._formatters,t)}else this._formatters||(this._formatters={}),this._formatters[t]=e},n.prototype.beginUndoSet=function(t){var e=this;(function(n){this.undoMgr.beginUndo(function(){e.set(t,n)},name)})(this[t])},n.prototype.endUndoSet=function(t){var e=this;(function(n){this.undoMgr.endUndo(function(){e.set(t,n)})})(this[t])},n.prototype.undoSet=function(t,e,n){this.beginUndoSet(t),this.set(t,e),this.endUndoSet(t,n)},n.prototype.destroy=function(){this.off()},n.prototype.retain=function(){if(this._destroyed)throw Error("Cannot retain destroyed object");return this._refCounter++,this},n.prototype.release=function(){if(this._refCounter--,0===this._refCounter)this.emit("destroy:"),this.destroy(),this._destroyed=!0,this._destroyedTrace="";else if(0>this._refCounter){var t;if(this._destroyed)throw t="Object has already been released",this._destroyedTrace&&(t+="\n"+this._destroyedTrace),Error(t);throw t="Invalid reference count!",Error(t)}return this},n.prototype.isDestroyed=function(){return 0===this._refCounter},n}(t.EventEmitter);t.Base=e})(Gnd||(Gnd={}));var ls=localStorage,Index=function(){function t(){this.tail={prev:0,next:0,key:""},this.index=[this.tail],this.first=this.last=0,this.unusedKeys=[]}return t.prototype.newIdx=function(){return this.unusedKeys.length>0?this.unusedKeys.pop():this.index.length},t.prototype.addKey=function(t){var e={prev:this.last,next:this.first,key:t},n=this.newIdx();this.index[n]=e;var i=this.index[this.first],o=this.index[this.last];return i.prev=n,o.next=n,this.first=n,n},t.prototype.touch=function(t){var e=this.remove(t);return this.addKey(e)},t.prototype.remove=function(t){if(0===t)return null;var e=this.index[t],n=this.index[e.next],i=this.index[e.prev];return n.prev=e.prev,i.next=e.next,t===this.first?this.first=e.next:t===this.last&&(this.last=e.prev),this.unusedKeys.push(t),e.key},t.prototype.getLast=function(){return this.first===this.last?null:this.index[this.tail.prev].key},t}(),Gnd;(function(t){var e=function(t){function e(e){e===void 0&&(e=5242880),t.call(this),this.size=0,this.length=0,this.maxSize=e,this.populate()}return __extends(e,t),e.prototype.each=function(t){var e;for(var n in this.map)if(e=t(n))return e},e.prototype.getKeys=function(){return _.keys(this.map)},e.prototype.getItem=function(t){var e,n=this.map[t];return n&&(e=ls[this.key(t,n.time)],e&&this.setItem(t,e)),e},e.prototype.setItem=function(t,e){var n=Date.now(),i=this.map[t];e+="";var o,r=e.length;i&&(r-=i.size),this.makeRoom(r)&&(this.size+=r,ls[this.key(t,n)]=e,i?(i.time!==n&&this.remove(t,i.time),o=i.idx,this.index.touch(o)):(this.length++,o=this.index.addKey(t)),this.map[t]={time:n,size:e.length,idx:o})},e.prototype.removeItem=function(t){var e=this.map[t];e&&(this.remove(t,e.time),this.size-=e.size,delete this.map[t],this.length--,this.index.remove(e.idx))},e.prototype.clear=function(){for(var t in this.map)this.removeItem(t);this.length=0,this.size=0},e.prototype.setMaxSize=function(t){this.maxSize=t},e.prototype.key=function(t,e){return t+"|"+e},e.prototype.remove=function(t,e){var t=this.key(t,e);delete ls[t]},e.prototype.populate=function(){var t,e,n,i,o,r,s=this;for(this.size=0,this.map={},this.index=new Index,t=0,e=ls.length;e>t;t++)n=ls.key(t),-1!=n.indexOf("|")&&(r=ls[n].length,i=n.split("|"),o=i[0],(!this.map[o]||this.map[o].time<i[1])&&(this.map[o]={time:i[1],size:r}),this.size+=r);var a=_.map(this.map,function(t,e){return{time:t.time,key:e}}),u=_.sortBy(a,function(t){return t.time});_.each(u,function(t){var e=s.index.addKey(t.key);s.map[t.key].idx=e}),this.length=_.size(this.map)},e.prototype.makeRoom=function(t){var e,n=this.maxSize-t;if(this.size>n){if(0>n)return!1;for(e=this.index.getLast();this.size>n;){if(null===e)return!1;this.removeItem(e),e=this.index.getLast()}}return!0},e}(t.Base);t.Cache=e})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(t,e,n){for(var i=0;t.length>i;i++)t[i]==e&&(t[i]=n)}var i=function(e){function i(t,n){e.call(this),this.createList={},this.currentTransfer=null,this.remoteStorage=null,this.localStorage=t,this.remoteStorage=n,this.useRemote=!!this.remoteStorage,this.syncFn=_.bind(this.synchronize,this)}return __extends(i,e),i.prototype.init=function(t){var e=this;this.localStorage.all(["meta","storageQueue"],function(n,i){n||(e.queue=i||[]),t(n)})},i.prototype.getDoc=function(t,e){var n=this;this.localStorage.get(t,function(n,i){i&&(i._id=_.last(t)),e(n,i)}),this.useRemote&&this.remoteStorage.get(t,function(e,o){e||(o._persisted=!0,n.emit("resync:"+i.makeKey(t),o),n.localStorage.put(t,o,function(){}))})},i.prototype.find=function(t,e,n,o){var r=this;this.localStorage.find(t,e,n,o),this.useRemote&&this.remoteStorage.find(t,e,n,function(e,n){e||r.emit("resync:"+i.makeKey(t),n)})},i.prototype.createCmd=function(t,e,n){var i=this;this.localStorage.create(t,e,function(o,r){o?n(o):(e.cid=r,i.add({cmd:"create",keyPath:t,args:e},n))})},i.prototype.updateCmd=function(t,e,n){var i=this;this.localStorage.put(t,e,function(o){o?n(o):i.add({cmd:"update",keyPath:t,args:e},n)})},i.prototype.deleteCmd=function(t,e){var n=this;this.localStorage.del(t,function(i){i?e(i):n.add({cmd:"delete",keyPath:t},e)})},i.prototype.addCmd=function(t,e,n,i){var o=this;this.localStorage.add(t,e,n,function(r){r?i(r):o.add({cmd:"add",keyPath:t,itemsKeyPath:e,itemIds:n},i)})},i.prototype.removeCmd=function(t,e,n,i){var o=this;this.localStorage.remove(t,e,n,function(r){r?i(r):o.add({cmd:"remove",keyPath:t,itemsKeyPath:e,itemIds:n},i)})},i.prototype.synchronize=function(){var t=this,e=_.bind(this.success,this);if(this.currentTransfer)console.log("busy with ",this.currentTransfer);else if(this.queue.length){var n=this.currentTransfer=this.queue[0],i=this.localStorage,o=this.remoteStorage,r=n.keyPath,s=n.itemsKeyPath,a=n.itemIds,u=n.args;switch(n.cmd){case"create":(function(n,s){o.create(r,s,function(o,s){o?e(o):i.put(r,{_persisted:!0,_id:s},function(){var o=_.initial(r);o.push(s),i.link(o,r,function(){t.updateQueueIds(n,s),t.emit("created:"+n,s),e()})})})})(u._cid,u);break;case"update":o.put(r,u,e);break;case"delete":o.del(r,e);break;case"add":o.add(r,s,a,e);break;case"remove":o.remove(r,s,a,e)}}else this.emit("synced:",this)},i.prototype.add=function(t,e){var n=this;this.useRemote?this.localStorage.insert(["meta","storageQueue"],-1,t,function(i){i||(n.queue.push(t),n.synchronize()),e(i)}):e()},i.prototype.success=function(e){var n=this;this.currentTransfer=null,e||(this.queue.shift(),this.localStorage.extract(["meta","storageQueue"],0,function(){t.Util.nextTick(_.bind(n.synchronize,n))}))},i.prototype.updateQueueIds=function(t,e){_.each(this.queue,function(i){n(i.keyPath,t,e),i.itemsKeyPath&&n(i.itemsKeyPath,t,e),i.itemIds&&n(i.itemIds,t,e)})},i.makeKey=function(t){return t.join(":")},i}(t.Base);e.Queue=i})(t.Storage||(t.Storage={})),t.Storage})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(t){var e=a.getItem(t);return e?JSON.parse(e):null}function i(t,e){var n=r(t);return _.map(e,function(t){return r([n,t])})}function o(t,e){a.setItem(t,JSON.stringify(e))}function r(t){return t.join("@")}function s(t){return _.isString(t)}var a=new t.Cache(1048576),u=function(){function e(){}return e.prototype.create=function(e,n,i){n._cid||(n._cid=t.Util.uuid()),e.push(n._cid),o(r(e),n),i(null,n._cid)},e.prototype.put=function(t,e,n){this.get(t,function(i,s){s&&(_.extend(s,e),o(r(t),s)),n(i)})},e.prototype.get=function(t,e){var i=n(r(t));i?s(i)?this.get(i.split("@"),e):e(null,i):e(Error("No local object available"))},e.prototype.del=function(t,e){a.removeItem(r(t)),e()},e.prototype.link=function(t,e,n){for(var i=r(e),s=r(t),u=a.getKeys(),c=0;u.length>c;c++)if(u[c].substring(0,i.length)===i){var h=u[c].replace(i,s);o(h,u[c])}n()},e.prototype.add=function(t,e,s,a){var u=r(t),c=i(e,s),h=n(u)||[];o(u,_.union(h,c)),a(null)},e.prototype.remove=function(t,e,a,u){for(var c=r(t),h=n(c)||[],d=i(e,a),f=0;d.length>f;f++){var p=n(d[f]);s(p)&&d.push(p)}o(c,_.difference(h,d)),u(null)},e.prototype.find=function(t,e,i,o){this.get(t,function(t,e){var i=[];if(e)for(var r=0;e.length>r;r++)i.push(n(e[r]));o(null,i)})},e.prototype.insert=function(t,e,i,s){var a=r(t),u=n(a)||[];-1==e?u.push(i):u.splice(e,0,i),o(a,u),s(null)},e.prototype.extract=function(t,e,i){var s=r(t),a=n(s)||[],u=a.splice(e,1)||[];o(s,a),i(null,u[0])},e.prototype.all=function(t,e){var i=r(t);e(null,n(i)||[])},e}();e.Local=u})(t.Storage||(t.Storage={})),t.Storage})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){var n=function(){function e(t){this.socket=t}return e.prototype.create=function(e,n,i){t.Util.safeEmit(this.socket,"create",e,n,i)},e.prototype.put=function(e,n,i){t.Util.safeEmit(this.socket,"put",e,n,i)},e.prototype.get=function(e,n){t.Util.safeEmit(this.socket,"get",e,n)},e.prototype.del=function(e,n){t.Util.safeEmit(this.socket,"del",e,n)},e.prototype.add=function(e,n,i,o){t.Util.safeEmit(this.socket,"add",e,n,i,o)},e.prototype.remove=function(e,n,i,o){t.Util.safeEmit(this.socket,"remove",e,n,i,o)},e.prototype.find=function(e,n,i,o){t.Util.safeEmit(this.socket,"find",e,n,i,o)},e.prototype.insert=function(e,n,i,o){t.Util.safeEmit(this.socket,"insert",e,n,i,o)},e.prototype.extract=function(e,n,i){t.Util.safeEmit(this.socket,"extract",e,n,i)},e.prototype.all=function(e,n){t.Util.safeEmit(this.socket,"all",e,n)},e}();e.Socket=n})(t.Storage||(t.Storage={})),t.Storage})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(t){return t.join(":")}function i(t){return n(t.getKeyPath())}var o=function(e){function o(i){function o(t,e,n,i){if(t)for(var o=0;t.length>o;o++)t[o].emit(e,n,i)}var r=this;e.call(this),this.docs={},this.socket=i,this.connectFn=function(){var e=r.socket;_.each(r.docs,function(n,i){var o=n[0];t.Util.safeEmit(e,"sync",o.getKeyPath(),function(t){t?console.log("Error syncing %s, %s",o.getKeyPath(),t):console.log("Syncing %s",o.getKeyPath())}),t.Util.safeEmit(e,"resync",o.getKeyPath(),function(t,e){if(t)console.log("Error resyncing %s, %s",e.getKeyPath(),t);else{e&&delete e.cid;for(var o=0,r=n.length;r>o;o++)n[o].set(e,{sync:"false"}),n[o].id(i)}})})},i.on("update:",function(t,e){var i=n(t);_.each(r.docs[i],function(t){t.set(e,{sync:!1})})}),i.on("delete:",function(t){var e=n(t);_.each(r.docs[e],function(e){e.emit("deleted:",t)})}),i.on("add:",function(t,e,i){var s=n(t);o(r.docs[s],"add:",e,i)}),i.on("remove:",function(t,e,i){var s=n(t);o(r.docs[s],"remove:",e,i)})}return __extends(o,e),o.prototype.init=function(){this.socket.on("connect",this.connectFn)},o.prototype.deinit=function(){var t=this.socket;t&&(t.removeListener("connect",this.connectFn),t.removeListener("reconnect",this.connectFn))},o.prototype.startSync=function(e){var n=i(e);this.socket,this.docs[n]?this.docs[n].push(e):(this.docs[n]=[e],t.Util.safeEmit(this.socket,"sync",e.getKeyPath(),function(){console.log("Start synching:"+e.getKeyPath())}))},o.prototype.endSync=function(e){if(e.isKeptSynced()){var n=i(e),o=(this.socket,this.docs[n]);o&&(o=_.reject(o,function(t){return t===e}),0===o.length?(console.log("Stop synching:"+n),t.Util.safeEmit(this.socket,"unsync",e.getKeyPath(),function(){console.log("Stop synching:"+e.getKeyPath())}),delete this.docs[n]):this.docs[n]=o)}},o}(t.Base);e.Manager=o})(t.Sync||(t.Sync={})),t.Sync})(Gnd||(Gnd={}));var Gnd;(function(t){(function(t){t._map=[],t._map[0]="INITIAL",t.INITIAL=0,t._map[1]="CREATING",t.CREATING=1,t._map[2]="CREATED",t.CREATED=2})(t.ModelState||(t.ModelState={}));var e=t.ModelState,n=function(n){function i(i,o){var r=this;n.call(this),this.__rev=0,this._persisted=!1,this._dirty=!0,this._keepSynced=!1,this.state=e.INITIAL,_.extend(this,i),this._cid=this._id||this._cid||t.Util.uuid(),this.__bucket=o,this.on("changed:",function(){r._dirty=!0})}return __extends(i,n),i.__bucket="",i.syncManager=null,i.storageQueue=null,i.extend=function(t){function e(e,i){n.call(this,e,t||i)}var n=this;return e.prototype=this.prototype,e.prototype._super=this,_.extend(e,{__bucket:t,extend:this.extend,create:this.create,findById:this.findById,all:this.all,fromJSON:this.fromJSON,fromArgs:this.fromArgs}),e},i.create=function(){t.overload({"Object Boolean Function":function(t,n,o){this.fromJSON(t,function(t,r){if(r){if(n&&r.keepSynced(),r.isPersisted())r.state=e.CREATED;else{var s=r.id();i.storageQueue.once("created:"+s,function(t){r.id(t),r.state=e.CREATED})}r.init(function(){o(null,r)})}else o(t)})},"Object Function":function(t,e){this.create(t,!1,e)}}).apply(this,arguments)},i.findById=function(){var e=this;return t.overload({"Array Boolean Object Function":function(t,n,o,r){return i.storageQueue.getDoc(t,function(t,i){i?(_.extend(i,o),e.create(i,n,r)):r(t)}),this},"String Boolean Object Function":function(t,e,n,i){return this.findById([this.__bucket,t],e,n,i)},"String Function":function(t,e){return this.findById(t,!1,{},e)},"String Boolean Function":function(t,e,n){return this.findById(t,e,{},n)},"String Object Function":function(t,e,n){return this.findById(t,!1,e,n)}}).apply(this,arguments)},i.removeById=function(t,e){var n=_.isArray(t)?t:[this.__bucket,t];i.storageQueue.deleteCmd(n,function(t){e(t)})},i.fromJSON=function(t,e){e(null,new this(t))},i.fromArgs=function(t,e){this.fromJson(t,e)},i.prototype.destroy=function(){i.syncManager&&i.syncManager.endSync(this),n.prototype.destroy.call(this)},i.prototype.init=function(t){t(this)},i.prototype.id=function(t){return t&&(this._cid=this._id=t,this._persisted=!0,this._keepSynced&&i.syncManager&&i.syncManager.startSync(this),this.emit("id",t)),this._id||this._cid},i.prototype.getName=function(){return"Model"},i.prototype.getKeyPath=function(){return[this.__bucket,this.id()]},i.prototype.isKeptSynced=function(){return this._keepSynced},i.prototype.isPersisted=function(){return this._persisted||this.state>=e.CREATED},i.prototype.bucket=function(){return this.__bucket},i.prototype.save=function(t){this._dirty&&this.update(this.toArgs(),t)},i.prototype.update=function(t,n){var o=this,r=this.__bucket,s=this.id();n=n||function(){},this.state==e.INITIAL?(t.state=this.state=e.CREATING,i.storageQueue.once("created:"+s,function(t){o.id(t),o._keepSynced&&i.syncManager&&i.syncManager.startSync(o),o.state=e.CREATED}),i.storageQueue.createCmd([r],t,n)):i.storageQueue.updateCmd([r,s],t,function(e){e||o.emit("updated:",o,t),n(e)})},i.prototype.delete=function(t){var e=this;t=t||function(){},i.removeById(this.getKeyPath(),function(n){i.syncManager&&i.syncManager.endSync(e),e.emit("deleted:",e.id()),t(n)})},i.prototype.keepSynced=function(){var t=this;this._keepSynced||(this._keepSynced=!0,this.isPersisted()&&i.syncManager&&i.syncManager.startSync(this),this.on("changed:",function(e,n){(!n||"false"!=n.sync&&!_.isEqual(e,n.doc))&&t.update(e)}))},i.prototype.toArgs=function(){var t={_persisted:this._persisted,_cid:this._cid};for(var e in this)_.isUndefined(this[e])||_.isNull(this[e])||_.isFunction(this[e])||"_"===e[0]||(_.isFunction(this[e].toArgs)?t[e]=this[e].toArgs():_.isObject(this[e])||(t[e]=this[e]));return t},i.all=function(){var e=this;t.overload({"Model Array Object Function":function(n,o,r,s){i.storageQueue.find(o,{},{},function(i,o){o?(_.each(o,function(t){_.extend(t,r)}),t.Collection.create(e,n,o,s)):s(i)})},"Model Object String Function":function(t,e,n,i){var o=t.getKeyPath();o.push(n),this.all(t,e,i)},"Model Function":function(t,e){var n=t.getKeyPath();n.push(this.__bucket),this.all(t,n,{},e)}}).apply(this,arguments)},i.prototype.all=function(t,e,n,i){t.all(this,e,n,i)},i}(t.Base);t.Model=n})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(e){function n(n,i,o){var r=this;e.call(this),this._keepSynced=!1,this._added=[],this._removed=[],this.sortOrder="asc",this.filterFn=null,this.count=0;var s=this;this.updateFn=function(t){if(s.sortByFn){var e=s.indexOf(this);s.items.splice(e,1),s.sortedAdd(this)}s.emit("updated:",this,t)},this.deleteFn=function(e){r.remove(e,!1,t.Util.noop)},this.items=o||[],this.initItems(this.items),this.model=n,this.parent=i,this.on("sortByFn sortOrder",function(){var t=r.items;r.sortByFn&&(r.items=r.sortBy(r.sortByFn)),"desc"==r.sortOrder&&r.items.reverse(),r.emit("sorted:",r.items,t)})}return __extends(n,e),n.prototype.destroy=function(){this._keepSynced&&this.endSync(),this.deinitItems(this.items),this.items=null,e.prototype.destroy.call(this)},n.create=function(e){function i(n,i){t.Util.asyncForEach(n,function(t,n){e.create(t,!1,function(t,e){e&&r.push(e),n(t)})},i)}function o(e,i,o){var r=new n(e,i,o);return t.Util.release(o),i&&i.isKeptSynced()&&r.keepSynced(),r.count=o.length,r}var r=[];t.overload({"Function Model Array Function":function(t,e,n,s){i(n,function(n){n?s(n,null):s(n,o(t,e,r))})},"Function Array Function":function(t,e,n){i(e,function(e){e?n(e,null):n(e,o(t,void 0,r))})},"Function Model Function":function(t,e,n){this.create(t,e,[],n)}}).apply(this,arguments)},n.getItemIds=function(t){return _.map(t,function(t){return t.id()})},n.prototype.findById=function(t){return this.find(function(e){return e.id()==t})},n.prototype.save=function(e){var i=this,o=[this.parent.bucket(),this.parent.id(),this.model.__bucket],r=[];this._removed.length?r=_.initial(this._removed[0].getKeyPath()):this._added.length&&(r=_.initial(this._added[0].getKeyPath()));var s=n.getItemIds(this._removed);t.Model.storageQueue.removeCmd(o,r,s,function(a){a?e(a):(i._removed=[],t.Util.asyncForEach(i.items,function(t,e){t.save(e)},function(a){!a&&i._added.length>0?(s=n.getItemIds(i._added),t.Model.storageQueue.addCmd(o,r,s,function(t){t||(i._added=[]),e(t)})):e(a)}))})},n.prototype.add=function(e,n,i){var o=this;_.isFunction(n)&&(i=n,n={}),t.Util.asyncForEach(e,function(t,e){o.addItem(t,n,function(n){!n&&o._keepSynced&&!t._keepSynced&&t.keepSynced(),e(n)})},i)},n.prototype.getKeyPath=function(){return[this.parent.bucket(),this.parent.id(),this.model.__bucket]},n.prototype.remove=function(e,n,i){var o=this,r=this.items,s=this.getKeyPath();_.isFunction(n)&&(i=n,n={}),t.Util.asyncForEach(e,function(e,i){var a,u,c=r.length;for(a=0;c>a;a++)if(r[a].id()==e){u=r[a];break}if(u){if(r.splice(a,1),u.off("changed:",o.updateFn),u.off("deleted:",o.deleteFn),o.set("count",r.length),o.emit("removed:",u,a),u.release(),!(!o._keepSynced||n&&n.nosync)){var h=_.initial(u.getKeyPath());return t.Model.storageQueue.removeCmd(s,h,[u.id()],i),void 0}o._removed.push(e)}i()},i)},n.prototype.keepSynced=function(){this.startSync(),this.map(function(t){t.keepSynced()})},n.prototype.isKeptSynced=function(){return this._keepSynced},n.prototype.toggleSortOrder=function(){this.set("sortOrder","asc"==this.sortOrder?"desc":"asc")},n.prototype.setFormatters=function(t){this._formatters=t,this.each(function(e){e.format(t)})},n.prototype.filtered=function(t){this.filterFn?t(null,this.filter(this.filterFn)):t(null,this.items)},n.prototype.isFiltered=function(t){return this.filterFn?this.filterFn(t):!0},n.prototype.reverse=function(){return this.items.reverse(),this},n.prototype.persistAddItem=function(e,n){var i=this.getKeyPath(),o=_.initial(e.getKeyPath());t.Model.storageQueue.addCmd(i,o,[e.id()],n)},n.prototype.addItem=function(t,e,n){var i=this;return this.findById(t.id())?n():(this.sortByFn?this.sortedAdd(t):this.items.push(t),this.initItems(t),this.set("count",this.items.length),this.emit("added:",t),this.isKeptSynced()?e&&e.nosync===!0?n():t.isPersisted()?this.persistAddItem(t,n):t.save(function(e){e?n():i.persistAddItem(t,n)}):(this._added.push(t),n()),void 0)},n.prototype.sortedAdd=function(t){"desc"==this.sortOrder&&this.items.reverse();var e=this.sortedIndex(t,this.sortByFn);return this.items.splice(e,0,t),"desc"==this.sortOrder&&this.items.reverse(),e},n.prototype.startSync=function(){var e=this;this._keepSynced=!0,t.Model.syncManager&&t.Model.syncManager.startSync(this),this.on("add:",function(n,i){t.Util.asyncForEach(i,function(i,o){e.findById(i)||t.Model.findById([n,i],!0,{},function(t,n){n&&e.addItem(n,{nosync:!0},o)})},t.Util.noop)}),this.on("remove:",function(n,i){e.remove(i,!0,t.Util.noop)}),t.Model.storageQueue&&t.Model.storageQueue.on("resync:"+this.getKeyPath().join(":"),function(){})},n.prototype.endSync=function(){t.Model.syncManager&&t.Model.syncManager.endSync(this),this._keepSynced=!1},n.prototype.initItems=function(t){t=_.isArray(t)?t:[t];for(var e=0,n=t.length;n>e;e++){var i=t[e];i.retain(),i.on("changed:",this.updateFn),i.on("deleted:",this.deleteFn)}},n.prototype.deinitItems=function(t){for(var e=0,n=t.length;n>e;e++){var i=t[e];i.off("changed:",this.updateFn),i.off("deleted:",this.deleteFn),i.release()}},n}(t.Base);t.Collection=e;var n=["forEach","each","map","reduce","reduceRight","find","detect","pluck","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty","groupBy"];_.each(n,function(t){e.prototype[t]=function(){return _[t].apply(_,[this.items].concat(_.toArray(arguments)))}})})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(e,n){_.isFunction(e)&&(n=e,e="/");var i,o=function(){if(url=location.hash.replace(/^#!?/,""),!i||i.url!==url){i&&i.queue.cancel(),i=new y(url,i&&i.nodes||[]);var e=i.index;n(i),e==i.index&&(i.isNotFound=!0,i.queue.end()),i.queue.wait(function(){if(i.isNotFound){if(!i.notFoundFn)return console.log("Undefined route:"+location.hash),void 0;i.index=1,i.initNode("body"),i.notFoundFn.call(i,i);var e=new t.TaskQueue;c(e,i.node())}})}};""===location.hash?e&&(location.hash="!"+e):o(),"onhashchange"in window?window.onhashchange=o:h=setInterval(o,50)}function i(){h&&(clearInterval(h),h=null),"onhashchange"in window&&(window.onhashchange=null)}function o(t){location.hash=t,"onhashchange"in window&&$(window).trigger("onhashchange")}function r(t,e,n){return":"===t.charAt(0)?(n[t.replace(":","")]=e,!0):!1}function s(t){var e={middlewares:[],selector:"body",cb:void 0,component:void 0,handler:void 0,args:void 0},n=0,i=t.length;if(_.isFunction(t[0]))e.middlewares=_.initial(t),e.cb=_.last(t);else{if(e.component=t[0],e.selector=t[1],n=2,_.isFunction(t[n]))for(;_.isFunction(t[n])&&i-1>n;)e.middlewares.push(t[n]),n++;i>n&&(_.isFunction(t[n])?e.cb=t[n]:e.handler=t[n],n++,i>n&&(e.args=t[n]))
}return e}function a(e,n,i){t.Util.asyncForEach(n,function(t,n){t(e,n)},i)}function u(t,e,n){for(var i=e.length-1;i>=n;i--){var o=e[i];o.$el||t.append(o.select),t.append(o.exit||o.hide,o.drain,o.leave)}}function c(t,e){t.append(e.select,e.hide,e.before,e.load,e.render,e.enter||e.show,e.after)}var h;e.listen=n,e.stop=i,e.redirect=o;var d=function(t){if(t){var e,n=t.split("&"),i=n.length,o={};for(e=0;i>e;e++){var r=n[e].split("=");o[decodeURIComponent(r[0])]=r[1]?decodeURIComponent(r[1]):""}return o}return{}},f=function(){function t(){this.drained=!1,this.pool=[]}return t.prototype.autorelease=function(){var t=this.pool;_.each(arguments,function(e){_.isArray(e)?t.push.apply(t,e):t.push(e)}),this.drained&&this.drain()},t.prototype.drain=function(){for(var t=0,e=this.pool.length;e>t;t++)this.pool[t].release();this.pool=[],this.drained=!0},t}(),p=t.overload({"Function Array Function":function(t,e,n){return function(i){(function(e){e.push(function(){n(i),0===n.length&&i()}),t.apply(null,e)})(_.clone(e))}},"Function Function":function(t,e){return p(t,[],e)},Function:function(e){return p(e,[],t.Util.noop)}}),l=function(t){var e,n,i=t.split("?");return e=i[0].split("/"),n=e.length,""===_.last(e)&&n>1&&e.splice(n-1,1),{components:e,query:d(i[1])}},y=function(){function e(e,n){this.nodes=[],this.index=0,this.level=0,this.params={},this.queue=new t.TaskQueue;var i,o,r,s=this;for(_.extend(s,l(e)),i=s.components,r=i.length,this.url=e,this.prevNodes=n,o=0;r>o;o++){var a=n[o];if(!a||a.component!==i[o])break;s.nodes.push({component:i[o],autoreleasePool:a.autoreleasePool})}for(s.startIndex=o,o=s.startIndex;r>o;o++)s.nodes.push({component:i[o],autoreleasePool:new f})}return e.prototype.currentSubPath=function(){for(var t="",e=0,n=this.index;n>e;e++)t+=this.components[e]+"/";return t.length>0&&(t=t.substr(0,t.length-1)),t},e.prototype.consume=function(t,e){var n=this,i=n.index;if(t){if(e!=i||i>=n.components.length)return!1;var o=n.components[i];if(!r(t,o,n.params)&&t!==o)return!1}return n.index++,!0},e.prototype.initNode=function(t,e){var n=this;(function(e){e.select=p(function(i){e.$el=n.$el=$(t),i()}),e.selector=t,e.hide=p(function(t){e.$el.hide(),t()}),e.show=p(function(t){e.$el.show(),t()}),e.drain=p(function(t){e.autoreleasePool.drain(),t()})})(e||n.node())},e.prototype.enterNode=function(t,e,n,i,o,r,s){var a=this;a.level=i+1,7==arguments.length?t&&t.call(a,r,o):(t&&t.call(a,o),s=r),a.isNotFound=n>=a.index&&!s,!a.isNotFound&&n>a.startIndex&&c(a.queue,e),(a.isNotFound||s)&&a.queue.end()},e.prototype.notFound=function(t){this.notFoundFn=t},e.prototype.use=function(t,e){switch(t){case"template":this.template=e}},e.prototype.node=function(){return this.nodes[0>=this.index?0:this.index-1]},e.prototype.get=function(){var t=this,e=s(arguments),n=e.component,i=e.handler,o=e.selector,r=e.cb,c=t.level;if(t.wantsRedirect||!t.consume(n,c))return t;var h=function(n){a(t,e.middlewares,function(){var s=t.node(),a=s.autoreleasePool,h=t.index,d=h===t.components.length;h==t.startIndex&&u(t.queue,t.prevNodes,t.startIndex),t.initNode(o,s),r?(t.enterNode(r,s,h,c,{},a,d),n()):curl([i],function(i){t.enterNode(i,s,h,c,e.args,a,d),n()})})};return t.queue.append(h),t.level=c,t},e.prototype.isLast=function(){return this.index>=this.components.length},e.prototype.nextComponent=function(){return this.components[this.index]},e.prototype.redirect=function(t,e){t=e?t+"?"+$.param(e):t,this.queue.wait(function(){o(t)}),this.wantsRedirect=!0},e.prototype.anim=function(t,e,n,i){t.$el[e](n||"fast",i)},e.prototype.before=function(t){var e=_.bind(function(t){t()},this);return this.node().before=p(e,t),this},e.prototype.after=function(t){var e=_.bind(function(t){t()},this);return this.node().after=p(e,t),this},e.prototype.exit=function(t,e,n){n=_.isFunction(e)?e:n,e=_.isFunction(e)?void 0:e;var i=this.node(),o=_.bind(this.anim,this);return i.exit=p(o,[i,t,e],n),this},e.prototype.enter=function(t,e,n){n=_.isFunction(e)?e:n,e=_.isFunction(e)?void 0:e;var i=this.node(),o=_.bind(this.anim,this);return i.enter=p(o,[i,t,e],n),this},e.prototype.leave=function(t){var e=_.bind(function(t){t()},this);return this.node().leave=p(e,t),this},e.prototype.render=function(){return t.overload({"String String Object Function":function(t,e,n,i){var o=_.bind(this.render,this);return this.node().render=p(o,[t,e,n],i),this},"String String Function":function(t,e,n){return this.render(t,e,void 0,n)},"String Object Function":function(t,e,n){return this.render(t,void 0,e,n)},"String Function":function(t,e){return this.render(t,void 0,void 0,e)},"String Function":function(e){return this.render(e,t.Util.noop)}})(arguments)},e.prototype.load=function(t,e){var n=_.bind(this._load,this);return this.node().load=p(n,[t],e),this},e.prototype._render=function(e,n,i,o){function r(t){var e;_.isString(i)?e[i]=a.data:e=_.isObject(i)?i:_.isObject(a.data)?a.data:{};var n=a.template?a.template(t,e):t;a.$el.html(n),s(a.$el,o)}function s(t,e){var n=$("img",t),i=n.length,o=0;i>0?n.one("load",function(){o++,o===i&&e()}):e()}var a=this;_.isObject(n)?(o=i,i=n,n=void 0):_.isFunction(n)?(o=n,n=void 0,i=void 0):_.isFunction(i)&&(o=i,i=void 0),o=o||t.Util.noop;var u=["text!"+e];n&&u.push("css!"+n),curl(u,function(t){r(t)})},e.prototype._load=function(t,e){var n,i,o=(this.currentSubPath(),this);null===t&&(t=o.data),_.isArray(t)||(t=[t]);var r=[];for(n=0,i=t.length;i>n;n++)r.push("text!"+t[n]);curl(r,function(){var t=arguments,r=[];for(n=0,i=t.length;i>n;n++)r.push(JSON.parse(arguments[n]));r=1===r.length?r[0]:r,o.data=r,e&&e()})},e}();y.prototype.render=y.prototype.load=t.overload({"String String Object Function":y.prototype.load,Function:function(t){return this.load([],t)},"":function(){return this.load([],t.Util.noop)}})})(t.Route||(t.Route={})),t.Route})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(t){function e(e,n,i){n===void 0&&(n={}),i===void 0&&(i="div"),t.call(this),this.classNames=e,this.css=n,this.tag=i,this.$el=$(this.tag),this.$el.css(this.css)}return __extends(e,t),e.prototype.render=function(t){return this.$parent=t||this.$parent,this.$parent&&this.$el&&this.$el.detach().appendTo(this.$parent),this.$el},e.prototype.refresh=function(){this.$parent&&this.render(this.$parent)},e.prototype.clean=function(){this.$el.detach()},e.prototype.remove=function(){this.$el.remove(),this.$el=null},e.prototype.disable=function(){console.log(this+" does not implement disable")},e.prototype.hide=function(){this.$el.hide(arguments)},e.prototype.show=function(){this.$el.show(arguments)},e.prototype.destroy=function(){this.remove(),t.prototype.destroy.call(this)},e}(t.Base);t.View=e})(Gnd||(Gnd={}));var Gnd;(function(t){function e(t,e){var n=e||document;switch(t[0]){case"#":return n.getElementById(t.slice(1));case".":return n.getElementsByClassName(t.slice(1))}return n.getElementsByTagName(t)}function n(t){return t&&t.nodeType===Node.ELEMENT_NODE}function i(t,e,n){t.addEventListener?t.addEventListener(e,n):t.attachEvent&&t.attachEvent("on"+e,n)}function o(t,e,n){t.removeEventListener?t.removeEventListener(e,n):t.detachEvent&&t.detachEvent("on"+e,n)}function r(t,e,n){t.hasOwnProperty(e)&&(t[e]=n),n?t.setAttribute(e,n):t.removeAttribute(e)}function s(t,e){if(t.hasOwnProperty(e))return t[e];var n=t.getAttribute(e);switch(n){case"true":return!0;case null:case"false":return!1;default:return n}}t.$$=e,t.isElement=n,t.addEventListener=i,t.removeEventListener=o,t.setAttr=r,t.getAttr=s})(Gnd||(Gnd={}));var Gnd;(function(t){function e(e,n){t.isElement(n)?e.parentNode.replaceChild(n,e):e.textContent?e.textContent=n:e.innerText=n}function n(t){for(var e=t.trim().split("."),n=0;e.length>n;n++)e[n]=e[n].trim();return e}var i=/^data-/,o=function(e){function n(t,n,i){e.call(this),this.contexts=[],this.boundBinders=[],this.binders={bind:r,each:s,show:a,"class":u,event:c},_.extend(this.binders,i),this.pushContext(n),this.boundBinders=this.bindNode(t)}return __extends(n,e),n.prototype.destroy=function(){this.unbind(),e.prototype.destroy.call(this)},n.prototype.unbind=function(t){_.each(t||this.boundBinders,function(t){t.unbind()}),!t&&(this.boundBinders=[])},n.prototype.resolveContext=function(t){for(var e,n=t[0],i=this.contexts.length-1;i>=0;i--)if(e=this.contexts[i][n])return this.resolveKeypath(e,_.rest(t))},n.prototype.pushContext=function(t){this.contexts.push(t)},n.prototype.popContext=function(){this.contexts.pop()},n.prototype.bindNode=function(e){var n=[];if(e.attributes)for(var o=e.attributes,r=0;o.length>r;r++)if(i.test(o[r].name)){var s=o[r].name.replace(i,""),a=o[r].value;if(this.binders[s]){var u=new this.binders[s];u.bind(e,a,this),n.push(u)}}if(e.hasChildNodes())for(var c=_.toArray(e.childNodes),h=0;c.length>h;h++)t.isElement(c[h])&&n.push.apply(n,this.bindNode(c[h]));return n},n.prototype.resolveKeypath=function(t,e){for(var n=0;e.length>n;n++)if(t=t[e[n]],!t)return null;return t},n}(t.Base);t.ViewModel=o;var r=function(){function i(){this.bindings=[]}return i.re=/((\s*(\w+)\s*\:\s*((\w+\.*)+)\s*);?)/gi,i.prototype.parse=function(t){for(var e,o={};e=i.re.exec(t);)o[e[3]]=n(e[4]);return o},i.prototype.bind=function(n,i,o){var r=this.parse(i);this.el=n;for(var s in r){var a=o.resolveContext(_.initial(r[s]));if(a instanceof t.Base){var u,c=_.rest(r[s]).join("."),h=null;"text"===s?(e(n,a.format(c)),u=function(){e(n,a.format(c))}):(t.setAttr(n,s,a.format(c)),u=function(){t.setAttr(n,s,a.format(c))},h=function(){a.set(c,t.getAttr(n,s))}),a.retain(),a.on(c,u),t.addEventListener(n,"change",h),this.bindings.push([a,c,u,h])}else console.log("Warning: not found a valid model: "+c[0])}},i.prototype.unbind=function(){var e=this;_.each(this.bindings,function(n){n[0].off(n[1],n[2]),n[0].release(),n[3]&&t.removeEventListener(e.el,"change",n[3])})},i}(),s=function(){function e(){this.items=[],this.mappings={}}return e.prototype.bind=function(e,i,o){var r=this,s=i.trim().split(":");if(2!==s.length)return console.log("Warning: syntax error in data-each:"+i),void 0;var a=this.mappings,u=e.nextSibling,c=n(s[0]),h=o.resolveContext(c),d=s[1].trim(),f=this.parent=e.parentNode;if(this.viewModel=o,h instanceof t.Collection){this.collection=h,f.removeChild(e),e.removeAttribute("data-each"),e.removeAttribute("id");var p=function(n,i){var r=e.cloneNode(!0),s=n.id(),u=function(e){delete a[s],s=e,a[s]=r,t.setAttr(r,"data-item",e)};t.setAttr(r,"data-item",s),a[s]=r,i?f.insertBefore(r,i):f.appendChild(r);var c={};c[d]=n,o.pushContext(c),r["gnd-bindings"]=o.bindNode(r),o.popContext(),n.on("id",u),r["gnd-obj"]=n},l=function(){h.filtered(function(t,e){_.each(e,function(t){p(t,u)})})},y=function(){r.removeNodes(),l()};y(),this.addedListener=function(t){h.isFiltered(t)&&p(t,u)},this.removedListener=function(t){a[t.id()]&&r.removeNode(t.id())},this.updatedListener=y,h.on("added:",this.addedListener).on("removed:",this.removedListener).on("filterFn sorted: updated:",this.updatedListener)}else console.log("Warning: not found a valid collection: "+s[0])},e.prototype.unbind=function(){this.collection.off("added:",this.addedListener),this.collection.off("removed:",this.removedListener),this.collection.off("filterFn sorted: updated:",this.updatedListener),this.removeNodes()},e.prototype.removeNode=function(t){var e=this.mappings[t];this.viewModel.unbind(e["gnd-bindings"]),e["gnd-obj"].release(),this.parent.removeChild(e),delete this.mappings[t]},e.prototype.removeNodes=function(){for(var t in this.mappings)this.removeNode(t)},e}(),a=function(){function e(){this.bindings=[]}return e.prototype.bind=function(e,i,o){function r(t){e.style.display=(a?!t:t)?h:"none"}var s=i.replace("!",""),a=s===i?!1:!0,u=n(s),c=o.resolveContext(_.initial(u)),h=e.style.display;if(c instanceof t.Base){c.retain();var d=_.rest(u).join("."),f=function(t){r(t)};r(c.get(d)),c.on(d,f),this.bindings.push([c,d,f])}else console.log("Warning: not found a valid model: "+i)},e.prototype.unbind=function(){_.each(this.bindings,function(t){t[0].off(t[1],t[2]),t[0].release()})},e}(),u=function(){function e(){this.bindings=[]}return e.prototype.bind=function(e,i,o){function r(){var t=c;for(var n in h)t=_.union(t,a[n]);e.className=t.join(" ")}for(var s=this,a={},u=i.split(";"),c=""===e.className?[]:e.className.split(" "),h={},d=function(e){var a=e.replace("!",""),u=a===e?!1:!0,c=n(a),d=o.resolveContext(_.initial(c));if(d instanceof t.Base){d.retain();var f,p=_.rest(c).join("."),l=u?!d.get(p):d.get(p);l&&(h[e]=e),f=function(t){(u?!t:t)?h[e]=e:delete h[e],r()},d.on(p,f),s.bindings.push([d,p,f])}else console.log("Warning: not found a valid model: "+i)},f=0;u.length>f;f++){var p=u[f].split(":");if(2===p.length){var l=p[0].trim().split(" "),y=p[1].trim();a[y]=[];for(var v=0;l.length>v;v++)a[y].push(l[v].trim());for(var y in a)d(y);r()}else console.log("Warning: Syntax error in "+u[f])}},e.prototype.unbind=function(){_.each(this.bindings,function(t){t[0].off(t[1],t[2]),t[0].release()})},e}(),c=function(){function e(){this.bindings=[]}return e.re=/((\s*(\w+)\s*\:\s*((\w+\.*)+)\s*);?)/gi,e.prototype.parse=function(t){for(var e,i={};e=r.re.exec(t);)i[e[3]]=n(e[4]);return i},e.prototype.bind=function(e,n,i){var o=this,r=this.parse(n);this.el=e;var s=function(n){var s=r[n],a=i.resolveContext(_.initial(s));if(a instanceof t.Base){var u=_.rest(s).join("."),c=a.get(u);if(a.retain(),_.isFunction(c)){var h=function(t){c.call(a,e,t)};t.addEventListener(e,n,h),o.bindings.push([a,n,h])}else console.log("Warning: the given handler is not a function: "+s)}else console.log("Warning: not found an object instance of Gnd.Base: "+s[0])};for(var a in r)s(a)},e.prototype.unbind=function(){var e=this;_.each(this.bindings,function(n){n[0].release(),t.removeEventListener(e.el,n[1],n[2])})},e}();String.prototype.trim||(String.prototype.trim=t.Util.trim)})(Gnd||(Gnd={})),function(t,e){"object"==typeof exports?t.module.exports=e():"function"==typeof define&&define.amd?define(e):t.returnExports=e()}(this,function(){return Gnd});