var Gnd;(function(t){function e(t,e){var n,e=e||document,o=new u,r=function(t){for(var e=0;t.length>e;e++)o[e]=t[e];o.length=t.length};if(_.isString(t)){var s=t;switch(s[0]){case"#":var a=s.slice(1);n=e.getElementById(a),n&&n.parentNode&&n.id===a&&r([n]);break;case".":var c=s.slice(1);r(e.getElementsByClassName(c));break;case"<":r([i(s)]);break;default:r(e.getElementsByTagName(s))}}else r([t]);return o}function n(t){return t&&t.nodeType===Node.ELEMENT_NODE}function i(t){var e,n=document.createElement("div"),i=document.createDocumentFragment();for(n.innerHTML=t;e=n.firstChild;)i.appendChild(e);return i}function o(t,e,n){Object.prototype.hasOwnProperty.call(t,e)&&(t[e]=n),n?t.setAttribute(e,n):t.removeAttribute(e)}function r(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e];var n=t.getAttribute(e);switch(n){case"true":return!0;case null:case"false":return!1;default:return n}}function s(t){t.style.display=r(t,"data-display")||"block"}function a(t){var e=t.style.display;"none"!=e&&o(t,"data-display",e),t.style.display="none"}function c(t){var e=[];for(var n in t)e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")}t.$=e;var u=function(){function t(){}return t.prototype.on=function(t,e){var n=this;return _.each(t.split(" "),function(t){_.each(n,function(n){n.addEventListener?n.addEventListener(t,e):n.attachEvent&&n.attachEvent("on"+t,e)})}),this},t.prototype.off=function(t,e){var n=this;return _.each(t.split(" "),function(t){_.each(n,function(n){n.removeEventListener?n.removeEventListener(t,e):n.detachEvent&&n.detachEvent("on"+t,e)})}),this},t.prototype.trigger=function(t){var e=this;return _.each(t.split(" "),function(t){_.each(e,function(e){if(document.createEventObject){var n=document.createEventObject();e.fireEvent("on"+t,n)}else{var i=document.createEvent("HTMLEvents");i.initEvent(t,!0,!0),!e.dispatchEvent(i)}})}),this},t.prototype.attr=function(t,e){return e?(_.each(this,function(n){o(n,t,e)}),this):r(this[0],t)},t.prototype.css=function(t){_.each(this,function(e){_.extend(e.style,t)})},t.prototype.show=function(){return _.each(this,function(t){s(t)}),this},t.prototype.hide=function(){return _.each(this,function(t){a(t)}),this},t.prototype.text=function(t){var e=this[0];if(e.textContent){if(!t)return e.textContent;_.each(this,function(e){e.textContent=t})}else{if(!t)return e.innerText;_.each(this,function(e){e.innerText=t})}},t.prototype.html=function(t){return _.isUndefined(t)?this[0].innerHTML:(_.each(this,function(e){e.innerHTML=t}),void 0)},t}();t.Query=u,t.isElement=n,t.makeElement=i,t.setAttr=o,t.getAttr=r,t.show=s,t.hide=a,t.serialize=c;var t;(function(t){(function(t){function e(t,e,n){s("GET",t,e,n)}function n(t,e,n){s("PUT",t,e,n)}function i(t,e,n){s("POST",t,e,n)}function o(t,e,n){s("DELETE",t,e,n)}function r(){for(var t=0;4>t;t++)try{return t?new ActiveXObject([,"Msxml2","Msxml3","Microsoft"][t]+".XMLHTTP"):new XMLHttpRequest}catch(e){}}function s(t,e,n,i){var o=r();o.onreadystatechange=function(){if(4===o.readyState)if(o.onreadystatechange=null,o.status>=200&&300>o.status){var t;try{t=JSON.parse(o.responseText||{})}catch(e){}i(null,t)}else i(Error("Ajax Error: "+o.responseText))},o.open(t,e),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(n))}t.get=e,t.put=n,t.post=i,t.del=o})(t.Ajax||(t.Ajax={})),t.Ajax})(t||(t={}))})(Gnd||(Gnd={}));var Gnd;(function(t){function e(t){return function(){for(var e=[],i=0;arguments.length-0>i;i++)e[i]=arguments[i+0];var o="";if(e.length){_.isUndefined(e[0])||(o+=n(e[0]));for(var r=1;e.length>r;r++)_.isUndefined(e[r])||(o+=" "+n(e[r]))}if(t[o])return t[o].apply(this,e);throw Error("Not matched function signature: "+o)}}function n(t){var e;return t&&t.getName?t.getName():(e=Object.prototype.toString.call(t),e.slice(8,e.length-1))}t.overload=e})(Gnd||(Gnd={}));var Gnd;(function(t){function e(){var t=this;return e.prototype._instance?e.prototype._instance:(e.prototype._instance=this,_.each(i,function(e,n){t[n]=e}),void 0)}function n(e,n){switch(e){case"template":t.using.template=n}}var i={template:function(t){return _.template(t)}};t.using=new e,t.use=n})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(){}function i(t,e){t||console.log("Assert failed:%s",e)}function o(t,e){for(e=t="";36>t++;e+=52&51*t?(15^t?8^Math.random()*(20^t?16:4):4).toString(16):"-");return e}function r(){window.location.replace("")}function s(t){var e=_.isArray(t)?t:arguments;_.each(e,function(t){t&&t.retain()})}function a(t){var e=_.isArray(t)?t:arguments;_.each(e,function(t){t&&t.release()})}function c(t){setTimeout(t,0)}function u(){return this.replace(/^\s+|\s+$/g,"")}function h(t){var e=null,n=null;return function(){var i=this,o=arguments,r=o.length,s=o[r-1],a=function(){n=t,t.apply(i,o)};o[r-1]=function(){if(s.apply(i,arguments),n=null,e){var t=e;e=null,t()}},n?e=a:a()}}function d(t,e,n,i){return function(){var o=this,r=!1,s=null,a=Array.prototype.slice.call(arguments),c=a.length,u=a[c-1];a[c-1]=function(){clearTimeout(s),r&&n(),u.apply(o,arguments)},s=setTimeout(function(){r=!0,e()},i),t.apply(this,a)}}function f(t,e,n){if(e){var i=!1;e=e.toLowerCase();for(var o=0,r=n.length;r>o;o++)-1!=(t[n[o]]+"").toLowerCase().indexOf(e)&&(i=!0);return i}return!0}function l(t,e,i){function o(t,o){e(t,function(t){t?(i&&i(t),i=n):(r++,r===o&&i&&i(null))})}var r=0;if(_.isArray(t))if(0===t.length)i&&i(null);else for(var s=0,a=t.length;a>s;s++)o(t[s],a);else o(t,1)}function p(t,e,i){function o(){e(t[r],function(e){e?(i(e),i=n):(r++,t.length>r?o():i())})}if(i=i||n,!t.length)return i();var r=0;o()}function y(t,e){function n(){this.constructor=o}var i,o=function(){t.apply(this,arguments)};return e&&(i=e(t.prototype),o=i.constructor),n.prototype=t.prototype,o.prototype=new n,_.extend(o.prototype,i),o}function v(t){function e(){r(Error("Socket disconnected"))}function n(n,i){t.removeListener("disconnect",e),n&&(n=Error(n)),r(n,i)}for(var i=[],o=0;arguments.length-1>o;o++)i[o]=arguments[o+1];var r=_.last(i);i[i.length-1]=n,t.socket.connected?(t.once("disconnect",e),t.emit.apply(t,i)):e()}function g(e,n){var i=t.$("img",e),o=i.length;if(o>0){var r=function(){i.off("load",r),o--,0===o&&n()};i.on("load",r)}else n()}function m(t,n,i){var o=[];t&&o.push("text!"+t),n&&o.push("css!"+n),i=i||e.noop;try{curl(o,function(t){i(null,t)})}catch(r){i(r)}}e.noop=n,e.assert=i,e.uuid=o,e.refresh=r,e.retain=s,e.release=a,e.nextTick=c,e.trim=u,e.asyncDebounce=h,e.waitTrigger=d,e.searchFilter=f,e.asyncForEach=l,e.asyncForEachSeries=p,e.extend=y,e.safeEmit=v,e.waitForImages=g,e.fetchTemplate=m})(t.Util||(t.Util={})),t.Util})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(){function t(){this.tasks=[],this.endPromise=new n}return t.prototype.append=function(){for(var t=[],e=0;arguments.length-0>e;e++)t[e]=arguments[e+0];if(this.isEnded)throw Error("TaskQueue already ended");return this.tasks.push.apply(this.tasks,_.compact(t)),this.executeTasks(),this},t.prototype.cancel=function(){this.isCancelled=!0},t.prototype.end=function(){return this.isEnded=!0,this.isExecuting||this.endPromise.resolve(),this},t.prototype.wait=function(t){this.endPromise.then(t)},t.prototype.executeTasks=function(){var t=this;if(this.tasks.length>0&&!this.isCancelled&&!this.isExecuting){this.isExecuting=!0;var e=this.tasks.splice(0,1)[0];e(function(){t.isExecuting=!1,t.executeTasks()})}else(this.isEnded||this.isCancelled)&&this.endPromise.resolve(this.isCancelled)},t}();t.TaskQueue=e;var n=function(){function t(){this.callbacks=[]}return t.prototype.then=function(t){this.resolved?this.fire(t):this.callbacks.push(t)},t.prototype.resolve=function(){for(var t=[],e=0;arguments.length-0>e;e++)t[e]=arguments[e+0];this.isAborted||(this.resolved=t,this.fireCallbacks())},t.prototype.abort=function(){this.isAborted=!0},t.prototype.fire=function(t){t.apply(this,this.resolved)},t.prototype.fireCallbacks=function(){var t=this.callbacks.length;if(t>0)for(var e=0;t>e;e++)this.fire(this.callbacks[e])},t}();t.Promise=n;var i=function(){function e(){for(var t=[],e=0;arguments.length-0>e;e++)t[e]=arguments[e+0];this.promises=t}return e.prototype.abort=function(){_.invoke(this.promises,"abort")},e.prototype.then=function(e){t.Util.asyncForEachSeries(this.promises,function(t,e){t&&t.then(e)},e)},e}();t.PromiseQueue=i})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(){function t(){}return t.prototype.getListeners=function(){return this._listeners=this._listeners||{},this._listeners},t.prototype.getNamespaces=function(){return this._namespaces=this._namespaces||{},this._namespaces},t.prototype.on=function(t,e){for(var n=t.split(" "),i=this.getListeners(),o=0,r=n.length;r>o;o++){var s,a,c=n[o].split("/");if(c.length>1?(a=c[0],s=c[1]):(a=null,s=c[0]),i[s]?i[s].push(e):i[s]=[e],a){var u=this.getNamespaces();u[a]=u[a]||{},u[a][s]?u[a][s].push(e):u[a][s]=[e]}this.emit("newListener",s,e)}return this},t.prototype.emit=function(t){for(var e=[],n=0;arguments.length-1>n;n++)e[n]=arguments[n+1];var i=this.getListeners();return i["*"]&&this._fire(i["*"],arguments),i[t]&&this._fire(i[t],e),this},t.prototype.off=function(t,e){if(e)for(var n=t.split(" "),i=0,o=n.length;o>i&&!this._removeListener(n[i],e);i++);else this.removeAllListeners(t);return this},t.prototype.listeners=function(t){var e=this.getListeners();return e[t]=e[t]||[]},t.prototype.once=function(t,e){function n(){i.off(t,n),e.apply(this,arguments)}var i=this;return i.on(t,n)},t.prototype.removeAllListeners=function(t){var e=this._listeners;if(e)if(t)for(var n=t.split(" "),i=0,o=n.length;o>i;i++)this._removeNamespacedEvent(n[i],e);else delete this._listeners;return this},t.prototype.namespace=function(t){var e=this,n={self:e,namespace:t,on:function(t,e){return this.self.on(this.namespace+"/"+t,e),n},off:function(t){var e=this.namespace+"/";return t&&(e+=t),this.self.off(e),n}};return n},t.prototype._fire=function(t,e){var n,i=[],o=t.length;for(n=0;o>n;n++)i[n]=t[n];for(n=0;o>n;n++)i[n].apply(this,e)},t.prototype._removeListener=function(t,e){var n,i=this._listeners;return i&&i[t]&&(n=_.indexOf(i[t],e),-1!==n)?(i[t].splice(n,1),!0):!1},t.prototype._removeNamespacedEvent=function(t,e){var n=this,i=n._namespaces,o=t.split("/");if(1===o.length)t=o[0],e&&delete e[t],i&&delete i[t];else if(i){var r=o[0];if(t=o[1],i[r]){var s;if(""===t){var a=i[r];_.each(a,function(t,e){for(var i=0,o=t.length;o>i;i++)n._removeListener(e,t[i])})}else if(s=_.union(s,i[r][t]))for(var c=0,u=e.length;u>c;c++)this._removeListener(t,s[c])}}},t}();t.EventEmitter=e,e.prototype.addListener=e.prototype.on,e.prototype.addObserver=e.prototype.on,e.prototype.removeListener=e.prototype.off,e.prototype.removeObserver=e.prototype.off})(Gnd||(Gnd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n},Gnd;(function(t){var e=function(t){function e(){t.apply(this,arguments),this.undones=[],this.actions=[],this.undoFn=null,this.group=null}return __extends(e,t),e.prototype.beginUndo=function(t,e){this.undoFn=t,this.name=e},e.prototype.endUndo=function(t,e){this.action(t,this.undoFn,e,this.name),this.undoFn=null},e.prototype.action=function(t,e,n,i){this.undones.length=0,i=_.isString(n)?n:i;var o={"do":t,undo:e,fn:n,name:i};this.group?this.actions.push(o):this.group.push(o),t(n)},e.prototype.beginGroup=function(t){this.group={name:t,actions:[]}},e.prototype.endGroup=function(){(function(t){this.action(function(){for(var e=0,n=t.length;n>e;e++)t[e].action["do"](t[e].action.fn)},function(){for(var e=0,n=t.length;n>e;e++)t[e].action.undo(t[e].action.fn)},function(){},t.name)})(this.group),this.group=null},e.prototype.canUndo=function(){return this.actions.length>0},e.prototype.canRedo=function(){return this.undones.length>0},e.prototype.undo=function(){var t=this.actions.pop();if(t){t.undo(t.fn);var e=t.name||"";this.emit("undo",e),this.undones.push(t)}},e.prototype.redo=function(){var t=this.undones.pop();if(t){t["do"](t.fn);var e=t.name||"";this.emit("redo",e),this.actions.push(t)}},e}(t.EventEmitter);t.UndoManager=e})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(e){function n(){return e.call(this),this._refCounter=1,this._bindings={},this._undoMgr=new t.UndoManager,this instanceof n?void 0:new n}return __extends(n,e),n.prototype._set=function(t,e,i){for(var o=t.split("."),r=this,s=o.length-1,a=o[s],c=0;s>c;c++){var u=this[o[c]];r=u?u:this[o[c]]=new n}if(_.isEqual(r[a],e)===!1||i&&i.force){var h=r[a],e=this.willChange?this.willChange(a,e):e;return r[a]=e,this.emit(t,e,h,i),!0}return!1},n.prototype.set=function(t,e,n){var i,o=!1,r=this;return"object"==typeof t?(n=e,i=t,_.each(i,function(t,e){o=r._set(e,t,n)?!0:o})):o=r._set(t,e,n),o&&(i||(i={},i[t]=e),r.emit("changed:",i,n)),this},n.prototype.willChange=function(t,e){return e},n.prototype.get=function(t){var e,n=t.split(".");e=this[n[0]];for(var i=1,o=n.length;o>i&&_.isObject(e);i++)e=e[n[i]];return e},n.prototype.bind=function(t,e,n){var i=n||t;this.unbind(t);var o=_.bind(e.set,e,i);this.on(t,o);var r=_.bind(this.set,this,t);return e.on(i,r),this._bindings[t]=[o,e,i,r],this.set(t,e[i]),this},n.prototype.unbind=function(t){var e=this._bindings;if(null!=e&&e[t]){var n=e[t];this.removeListener(t,n[0]),n[1].removeListener(n[2],n[3]),delete e[t]}},n.prototype.beginUndoSet=function(t){var e=this;(function(n){this.undoMgr.beginUndo(function(){e.set(t,n)},name)})(this[t])},n.prototype.endUndoSet=function(t){var e=this;(function(n){this.undoMgr.endUndo(function(){e.set(t,n)})})(this[t])},n.prototype.undoSet=function(t,e){this.beginUndoSet(t),this.set(t,e),this.endUndoSet(t)},n.prototype.destroy=function(){this.emit("destroy:"),this._destroyed=!0,this._destroyedTrace="",this.off()},n.prototype.retain=function(){if(this._destroyed)throw Error("Cannot retain destroyed object");return this._refCounter++,this},n.prototype.release=function(){if(this._refCounter--,0===this._refCounter)this.destroy();else if(0>this._refCounter){var t;if(this._destroyed)throw t="Object has already been released",this._destroyedTrace&&(t+="\n"+this._destroyedTrace),Error(t);throw t="Invalid reference count!",Error(t)}return this},n.prototype.autorelease=function(){var e=this;return t.Util.nextTick(function(){e.release()}),this},n.prototype.isDestroyed=function(){return 0===this._refCounter},n}(t.EventEmitter);t.Base=e})(Gnd||(Gnd={}));var ls=localStorage,Index=function(){function t(){this.tail={prev:0,next:0,key:""},this.index=[this.tail],this.first=this.last=0,this.unusedKeys=[]}return t.prototype.newIdx=function(){return this.unusedKeys.length>0?this.unusedKeys.pop():this.index.length},t.prototype.addKey=function(t){var e={prev:this.last,next:this.first,key:t},n=this.newIdx();this.index[n]=e;var i=this.index[this.first],o=this.index[this.last];return i.prev=n,o.next=n,this.first=n,n},t.prototype.touch=function(t){var e=this.remove(t);return this.addKey(e)},t.prototype.remove=function(t){if(0===t)return null;var e=this.index[t],n=this.index[e.next],i=this.index[e.prev];return n.prev=e.prev,i.next=e.next,t===this.first?this.first=e.next:t===this.last&&(this.last=e.prev),this.unusedKeys.push(t),e.key},t.prototype.getLast=function(){return this.first===this.last?null:this.index[this.tail.prev].key},t}(),Gnd;(function(t){var e=function(t){function e(e){e===void 0&&(e=5242880),t.call(this),this.size=0,this.length=0,this.maxSize=e,this.populate()}return __extends(e,t),e.prototype.each=function(t){var e;for(var n in this.map)if(e=t(n))return e},e.prototype.getKeys=function(){return _.keys(this.map)},e.prototype.serialize=function(t,e){return t+"|"+e},e.prototype.deserialize=function(t){var e;return _.isString(t)&&(e=t.indexOf("|"),e>-1)?{time:+t.slice(0,e),value:t.slice(e+1)}:{time:-1,value:void 0}},e.prototype.getItem=function(t){var e,n,i=this.map[t];return i&&(e=this.deserialize(ls[t]),n=e.value,n&&this.setItem(t,n)),n},e.prototype.setItem=function(t,e){var n=Date.now(),i=this.map[t];e+="";var o,r=e.length;i&&(r-=i.size),this.makeRoom(r)&&(this.size+=r,ls[t]=this.serialize(n,e),i?(o=i.idx,this.index.touch(o)):(this.length++,o=this.index.addKey(t)),this.map[t]={size:e.length,idx:o})},e.prototype.removeItem=function(t){var e=this.map[t];e&&(this.remove(t),this.size-=e.size,delete this.map[t],this.length--,this.index.remove(e.idx))},e.prototype.clear=function(){for(var t in this.map)this.removeItem(t);this.length=0,this.size=0},e.prototype.setMaxSize=function(t){this.maxSize=t},e.prototype.remove=function(t){delete ls[t]},e.prototype.populate=function(){var t,e,n,i,o,r=this,s=[];for(this.size=0,this.map={},this.index=new Index,t=0,e=ls.length;e>t;t++)n=ls.key(t),i=this.deserialize(ls[n]),i.value&&(o=i.value.length,s.push({time:i.time,key:n}),this.map[n]={size:o},this.size+=o);var a=_.sortBy(s,function(t){return t.time});_.each(a,function(t){var e=r.index.addKey(t.key);r.map[t.key].idx=e}),this.length=_.size(this.map)},e.prototype.makeRoom=function(t){var e,n=this.maxSize-t;if(this.size>n){if(0>n)return!1;for(e=this.index.getLast();this.size>n;){if(null===e)return!1;this.removeItem(e),e=this.index.getLast()}}return!0},e}(t.Base);t.Cache=e})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(t,e,n){for(var i=[],o=0;t.length>o;o++)t[o]==e&&(t[o]=n,i.push(e));return i}var i=function(e){function i(t,n){e.call(this),this.createList={},this.currentTransfer=null,this.remoteStorage=null,this.localStorage=t,this.remoteStorage=n,this.queue=[],this.useRemote=!!this.remoteStorage,this.syncFn=_.bind(this.synchronize,this)}return __extends(i,e),i.makeKey=function(t){return t.join(":")},i.prototype.init=function(t){var e=this;this.localStorage.all(["meta","storageQueue"],function(n,i){n||(e.queue=i||[]),t(n)})},i.prototype.fetch=function(t,e){var n=this;this.localStorage.fetch(t,function(o,r){r&&(r._id=_.last(t),e(o,r)),n.useRemote?n.remoteStorage.fetch(t,function(o,s){o||(s._persisted=!0,n.localStorage.put(t,s,function(e){if(e){var i=_.initial(t);s._cid=s._id,n.localStorage.create(i,s,function(){})}}),n.emit("resync:"+i.makeKey(t),s)),!r&&e(o,s)}):e(o)})},i.prototype.updateLocalCollection=function(e,n,i,o,r){var s=this.localStorage,a=[_.last(e)];i=_.extend({snapshot:!1},i),s.find(e,n,i,function(n,i){function c(t,e){return _.find(t,function(t){return t._cid===e._cid||t._cid===e._id})}if(n)s.add(e,a,_.pluck(o,"_id"),{insync:!0},r);else{var u=[],h=[];_.each(i,function(t){"insync"!==t.__op||c(o,t)||u.push(t._cid,t._id)}),_.each(o,function(t){!c(i,t)&&h.push(t._id)}),s.remove(e,a,u,{insync:!0},function(n){n?r(n):t.Util.asyncForEach(o,function(t,e){var n=a.concat(t._id);t._persisted=!0,s.put(n,t,function(n){n?(t._cid=t._id,s.create(a,t,function(t){e(t)})):e()})},function(t){t?r(t):s.add(e,a,h,{insync:!0},r)})})}})},i.prototype.find=function(t,e,n,o){var r=this,s=_.extend({snapshot:!0},n);this.localStorage.find(t,e,s,function(a,c){c&&o(a,c),r.useRemote?r.remoteStorage.find(t,e,n,function(a,u){a||r.updateLocalCollection(t,e,n,u,function(){c&&r.localStorage.find(t,e,s,function(e,n){!e&&r.emit("resync:"+i.makeKey(t),n)})}),!c&&o(a,u)}):c||o(a)})},i.prototype.create=function(t,e,n){var i=this;this.localStorage.create(t,e,function(o,r){o?n(o):(e._cid=e._cid||r,i.addCmd({cmd:"create",keyPath:t,args:e},function(t){n(t,r)}))})},i.prototype.put=function(t,e,n){var i=this;this.localStorage.put(t,e,function(o){o?n(o):i.addCmd({cmd:"update",keyPath:t,args:e},n)})},i.prototype.del=function(t,e){var n=this;this.localStorage.del(t,function(i){i?e(i):n.addCmd({cmd:"delete",keyPath:t},e)})},i.prototype.add=function(t,e,n,i){var o=this;this.localStorage.add(t,e,n,{},function(r){r?i(r):o.addCmd({cmd:"add",keyPath:t,itemsKeyPath:e,itemIds:n},i)})},i.prototype.remove=function(t,e,n,i){var o=this;this.localStorage.remove(t,e,n,{},function(r){r?i(r):o.addCmd({cmd:"remove",keyPath:t,itemsKeyPath:e,itemIds:n},i)})},i.prototype.insert=function(){},i.prototype.extract=function(){},i.prototype.all=function(){},i.prototype.synchronize=function(){var t=this,e=_.bind(this.success,this);if(this.currentTransfer)console.log("busy with ",this.currentTransfer);else if(this.queue.length){var n=this.currentTransfer=this.queue[0],i=this.localStorage,o=this.remoteStorage,r=n.keyPath,s=n.itemsKeyPath,a=n.itemIds,c=n.args;switch(n.cmd){case"create":(function(n,s){o.create(r,s,function(o,s){var a=r.concat(n);o?e(o):i.put(a,{_persisted:!0,_id:s},function(){var o=_.initial(a);o.push(s),i.link(o,a,function(){t.emit("created:"+n,s),t.updateQueueIds(n,s),e()})})})})(c._cid,c);break;case"update":o.put(r,c,e);break;case"delete":o.del(r,e);break;case"add":o.add(r,s,a,{},e);break;case"remove":o.remove(r,s,a,{},e)}}else this.emit("synced:",this)},i.prototype.isEmpty=function(){return!this.queue.length},i.prototype.clear=function(e){this.queue=[],this.localStorage.del(["meta","storageQueue"],e||t.Util.noop)},i.prototype.addCmd=function(t,e){var n=this;this.useRemote?this.localStorage.insert(["meta","storageQueue"],-1,t,function(i){i||(n.queue.push(t),n.synchronize()),e(i)}):e()},i.prototype.success=function(e){this.currentTransfer=null;var n=this.localStorage;if(!e){var i=this.queue.shift(),o=_.bind(this.synchronize,this);n.extract(["meta","storageQueue"],0,function(){var e={insync:!0};switch(i.cmd){case"add":n.remove(i.keyPath,i.itemsKeyPath,i.oldItemIds||[],e,function(){n.add(i.keyPath,i.itemsKeyPath,i.itemIds,e,function(){t.Util.nextTick(o)})});break;case"remove":n.remove(i.keyPath,i.itemsKeyPath,i.oldItemIds||[],e,function(){n.remove(i.keyPath,i.itemsKeyPath,i.itemIds,e,function(){t.Util.nextTick(o)})});break;default:t.Util.nextTick(o)}})}},i.prototype.updateQueueIds=function(t,e){_.each(this.queue,function(i){n(i.keyPath,t,e),i.itemsKeyPath&&n(i.itemsKeyPath,t,e),i.itemIds&&(i.oldItemIds=n(i.itemIds,t,e))})},i}(t.Base);e.Queue=i})(t.Storage||(t.Storage={})),t.Storage})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(t){var e=h.getItem(t);return e?JSON.parse(e):null}function i(t,e){var n=r(t);return _.map(e,function(t){return r([n,t])})}function o(t,e){h.setItem(t,JSON.stringify(e))}function r(t){return t.join("@")}function s(t){return _.isString(t)}function a(t){return"/"===t[0]&&"/"===t[t.length-1]}function c(t){var e="/^"+t+"@[^@]+$/";o(t,e)}function u(t,e){var i=n(t);if(i){if(e&&e(t),s(i)){if(a(i)){var o=RegExp(i.slice(1,i.length-1)),r=h.getKeys(),c=_.filter(r,function(t){if(t.match(o)){var e=n(t);return!s(e)}return!1});return{key:t,value:_.reduce(c,function(t,e){return t[e]="insync",t},{})}}return u(i)}return{key:t,value:i}}}var h=new t.Cache(1048576),d=Error("Invalid Key"),f=function(){function e(){}return e.prototype.create=function(e,n,i){n._cid||(n._cid=t.Util.uuid()),o(r(e.concat(n._cid)),n),i(null,n._cid)},e.prototype.fetch=function(t,e){var n=u(r(t));n?e(null,n.value):e(d)},e.prototype.put=function(t,e,n){var i=(r(t),u(r(t)));i?(_.extend(i.value,e),o(i.key,i.value),n()):n(d)},e.prototype.del=function(t,e){u(r(t),function(){h.removeItem(r(t))}),e()},e.prototype.link=function(t,e,n){for(var i=r(e),s=r(t),a=h.getKeys(),c=0;a.length>c;c++)if(a[c].substring(0,i.length)===i){var u=a[c].replace(i,s);o(u,a[c])}n()},e.prototype.add=function(t,e,n,s,a){var h=r(t),d=i(e,n),f=u(h),l=f?f.value||{}:{},p={};return 1===t.length&&1===e.length?(c(t[0]),a()):(h=f?f.key:h,_.each(d,function(t){p[t]=s.insync?"insync":"add"}),o(h,_.extend(l,p)),a(),void 0)},e.prototype.remove=function(t,e,n,s,a){var c=r(t),h=i(e,n),f=u(c);if(0===n.length)return a();if(f){var l=f.value;_.each(h,function(t){u(t,function(){s.insync?delete l[t]:l[t]="rm"})}),o(f.key,l),a()}else a(d)},e.prototype.find=function(t,e,n,i){this.fetch(t,function(t,e){var o={};e&&_.each(_.keys(e),function(t){var i=e[t];if("rm"!==i||!n.snapshot){var r=u(t);if(r){var s=r.value,a=s._cid;o[a]&&"insync"!==i||(n.snapshot||(s.__op=i),o[a]=s)}}}),i(null,_.values(o))})},e.prototype.insert=function(t,e,i,s){var a=r(t),c=n(a)||[];-1==e?c.push(i):c.splice(e,0,i),o(a,c),s(null)},e.prototype.extract=function(t,e,i){var s=r(t),a=n(s)||[],c=a.splice(e,1)||[];o(s,a),i(null,c[0])},e.prototype.all=function(t,e){var i=r(t);e(null,n(i)||[])},e}();e.Local=f})(t.Storage||(t.Storage={})),t.Storage})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){var n=function(){function e(t){this.socket=t}return e.prototype.create=function(e,n,i){t.Util.safeEmit(this.socket,"create",e,n,i)},e.prototype.put=function(e,n,i){delete n._id,t.Util.safeEmit(this.socket,"put",e,n,i)},e.prototype.fetch=function(e,n){t.Util.safeEmit(this.socket,"get",e,n)},e.prototype.del=function(e,n){t.Util.safeEmit(this.socket,"del",e,n)},e.prototype.add=function(e,n,i,o,r){t.Util.safeEmit(this.socket,"add",e,n,i,r)},e.prototype.remove=function(e,n,i,o,r){t.Util.safeEmit(this.socket,"remove",e,n,i,r)},e.prototype.find=function(e,n,i,o){t.Util.safeEmit(this.socket,"find",e,n,i,o)},e.prototype.insert=function(e,n,i,o){t.Util.safeEmit(this.socket,"insert",e,n,i,o)},e.prototype.extract=function(e,n,i){t.Util.safeEmit(this.socket,"extract",e,n,i)},e.prototype.all=function(e,n){t.Util.safeEmit(this.socket,"all",e,n)},e}();e.Socket=n})(t.Storage||(t.Storage={})),t.Storage})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(t,e,n,i){if(t)for(var o=0;t.length>o;o++)t[o].emit(e,n,i)}function i(t){return t.join(":")}function o(t){return i(t.getKeyPath())}var r=function(e){function r(o){var r=this;e.call(this),this.docs={},this.socket=o,this.connectFn=function(){var e=r.socket;_.each(r.docs,function(n){var i=n[0];t.Util.safeEmit(e,"sync",i.getKeyPath(),function(t){t?console.log("Error syncing %s, %s",i.getKeyPath(),t):console.log("Syncing %s",i.getKeyPath())}),t.Util.safeEmit(e,"resync",i.getKeyPath(),function(t,e){if(t)console.log("Error resyncing %s, %s",e.getKeyPath(),t);else for(var i=0,o=n.length;o>i;i++)n[i].set(e,{nosync:!0})})})},o.on("update:",function(t,e){var n=i(t);_.each(r.docs[n],function(t){t.set(e,{nosync:!0})})}),o.on("delete:",function(t){var e=i(t);_.each(r.docs[e],function(e){e.emit("deleted:",t)})}),o.on("add:",function(t,e,o){var s=i(t);n(r.docs[s],"add:",e,o)}),o.on("remove:",function(t,e,o){var s=i(t);n(r.docs[s],"remove:",e,o)})}return __extends(r,e),r.prototype.init=function(){this.socket.on("connect",this.connectFn)},r.prototype.deinit=function(){var t=this.socket;t&&(t.removeListener("connect",this.connectFn),t.removeListener("reconnect",this.connectFn))},r.prototype.startSync=function(e){var n=o(e);this.socket,this.docs[n]?this.docs[n].push(e):(this.docs[n]=[e],t.Util.safeEmit(this.socket,"sync",e.getKeyPath(),function(){console.log("Start synching:"+e.getKeyPath())}))},r.prototype.endSync=function(e){if(e.isKeptSynced()){var n=o(e),i=(this.socket,this.docs[n]);i&&(i=_.reject(i,function(t){return t===e}),0===i.length?(console.log("Stop synching:"+n),t.Util.safeEmit(this.socket,"unsync",e.getKeyPath(),function(){console.log("Stop synching:"+e.getKeyPath())}),delete this.docs[n]):this.docs[n]=i)}},r}(t.Base);e.Manager=r})(t.Sync||(t.Sync={})),t.Sync})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(e){function n(i,o){var r=this;e.call(this),this.__rev=0,this._persisted=!1,this._dirty=!0,this._keepSynced=!1,this._initial=!0,_.extend(this,i),this._cid=this._id||this._cid||t.Util.uuid(),this.__bucket=o,this.on("changed:",function(){r._dirty=!0});var s=function(){n.storageQueue.on("resync:"+t.Storage.Queue.makeKey(r.getKeyPath()),function(t){r.set(t,{nosync:!0}),r.emit("resynced:")})};n.storageQueue&&(this.isPersisted()?s():this.once("id",s))}return __extends(n,e),n.extend=function(t){function e(e,i){n.call(this,e,t||i)}var n=this;return e.prototype=this.prototype,e.prototype._super=this,_.extend(e,{__bucket:t,extend:this.extend,create:this.create,findById:this.findById,all:this.all,allModels:this.allModels,createModels:this.createModels,fromJSON:this.fromJSON,fromArgs:this.fromArgs}),e},n.create=function(){t.overload({"Object Boolean Function":function(t,e,i){this.fromJSON(t,function(t,o){if(o){if(e&&o.keepSynced(),!o.isPersisted()){var r=o.id();n.storageQueue.once("created:"+r,function(t){o.id(t)})}o.init(function(){i(null,o)})}else i(t)})},"Object Function":function(t,e){this.create(t,!1,e)}}).apply(this,arguments)},n.findById=function(){return t.overload({"Array Boolean Object Function":function(t,e,i,o){var r=this;return n.storageQueue.fetch(t,function(t,n){n?(_.extend(n,i),r.create(n,e,o)):o(t)}),this},"String Boolean Object Function":function(t,e,n,i){return this.findById([this.__bucket,t],e,n,i)},"String Function":function(t,e){return this.findById(t,!1,{},e)},"String Boolean Function":function(t,e,n){return this.findById(t,e,{},n)},"String Object Function":function(t,e,n){return this.findById(t,!1,e,n)}}).apply(this,arguments)},n.removeById=function(t,e){var i=_.isArray(t)?t:[this.__bucket,t];n.storageQueue.del(i,function(t){e(t)})},n.fromJSON=function(t,e){e(null,new this(t))},n.fromArgs=function(t,e){this.fromJson(t,e)},n.prototype.destroy=function(){n.syncManager&&n.syncManager.endSync(this),e.prototype.destroy.call(this)},n.prototype.init=function(t){t(this)},n.prototype.id=function(t){return t&&(this._id=t,this._persisted=!0,this.emit("id",t)),this._id||this._cid},n.prototype.getName=function(){return"Model"},n.prototype.getKeyPath=function(){return[this.__bucket,this.id()]},n.prototype.isKeptSynced=function(){return this._keepSynced},n.prototype.isPersisted=function(){return this._persisted},n.prototype.bucket=function(){return this.__bucket},n.prototype.save=function(t){this._dirty&&this.update(this.toArgs(),t)},n.prototype.update=function(t,e){var i=this,o=this.__bucket,r=this.id();e=e||function(){},this._initial?(t._initial=this._initial=!1,n.storageQueue.once("created:"+r,function(t){i.id(t)}),n.storageQueue.create([o],t,function(t){e(t)})):n.storageQueue.put([o,r],t,function(n){n||i.emit("updated:",i,t),e(n)})},n.prototype.remove=function(t){var e=this;t=t||function(){},n.removeById(this.getKeyPath(),function(i){n.syncManager&&n.syncManager.endSync(e),e.emit("deleted:",e.id()),t(i)})},n.prototype.keepSynced=function(){var t=this;if(!this._keepSynced){this._keepSynced=!0;var e=function(){n.syncManager&&n.syncManager.startSync(t)};this.isPersisted()?e():this.once("id",e),this.on("changed:",function(e,n){n&&(n.nosync||_.isEqual(e,n.doc))||t.update(e)})}},n.prototype.toArgs=function(){var t={_persisted:this._persisted,_cid:this._cid};for(var e in this)_.isUndefined(this[e])||_.isNull(this[e])||_.isFunction(this[e])||"_"===e[0]||(_.isFunction(this[e].toArgs)?t[e]=this[e].toArgs():_.isObject(this[e])||(t[e]=this[e]));return t},n.createModels=function(e,n){var i=this,o=[];t.Util.asyncForEach(e,function(t,e){i.create(t,function(t,n){n&&o.push(n),e(t)})},function(t){n(t,o)})},n.allModels=function(t){var e=this;n.storageQueue.find([this.__bucket],{},{},function(n,i){i?e.createModels(i,t):t(n)})},n.all=function(){var e=this,i=function(i,o,r,s){n.storageQueue.find(o,{},{},function(n,o){o?(_.each(o,function(t){_.extend(t,r)}),t.Collection.create(e,i,o,s)):s(n)})};t.overload({"Model Array Object Function":function(t,e,n,o){i(t,e,n,o)},"Model Object String Function":function(t,e,n,o){var r=t.getKeyPath();r.push(n),i(t,r,e,o)},"Model Function":function(t,e){var n=t.getKeyPath();n.push(this.__bucket),i(t,n,{},e)}}).apply(this,arguments)},n.prototype.all=function(t,e,n,i){t.all(this,e,n,i)},n}(t.Base);t.Model=e})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(e){function n(n,i,o){var r=this;e.call(this),this._keepSynced=!1,this._added=[],this._removed=[],this.sortOrder="asc",this.filterFn=null,this.count=0;var s=this;this.updateFn=function(t){if(s.sortByFn){var e=s.indexOf(this);s.items.splice(e,1),s.sortedAdd(this)}s.emit("updated:",this,t)},this.deleteFn=function(e){r.remove(e,!1,t.Util.noop)},this.items=o||[],this.initItems(this.items),this.model=n,this.parent=i,this.on("sortByFn sortOrder",function(){var t=r.items;r.sortByFn&&(r.items=r.sortBy(r.sortByFn)),"desc"==r.sortOrder&&r.items.reverse(),r.emit("sorted:",r.items,t)}),i?i.isPersisted()?this.listenToResync():i.once("id",function(){r.listenToResync()}):this.listenToResync()}return __extends(n,e),n.prototype.destroy=function(){this._keepSynced&&this.endSync(),this.deinitItems(this.items),this.items=null,e.prototype.destroy.call(this)
},n.create=function(){return t.overload({"Function Model Array":function(e,i,o){var r=new n(e,i,o);return t.Util.release(o),i&&i.isKeptSynced()&&r.keepSynced(),r.count=o.length,r},"Function Model Array Function":function(t,e,n,i){var o=this;t.createModels(n,function(n,r){n?i(n):i(n,o.create(t,e,r))})},"Function Array Function":function(t,e,n){this.create(t,void 0,e,n)},"Function Model Function":function(t,e,n){this.create(t,e,[],n)}}).apply(this,arguments)},n.getItemIds=function(t){return _.map(t,function(t){return t.id()})},n.prototype.findById=function(t){return this.find(function(e){return e.id()==t})},n.prototype.save=function(e){var i=this,o=this.getKeyPath(),r=[];this._removed.length?r=_.initial(this._removed[0].getKeyPath()):this._added.length&&(r=_.initial(this._added[0].getKeyPath()));var s=n.getItemIds(this._removed);t.Model.storageQueue.remove(o,r,s,function(a){a?e(a):(i._removed=[],t.Util.asyncForEach(i.items,function(t,e){t.save(e)},function(a){!a&&i._added.length>0?(s=n.getItemIds(i._added),t.Model.storageQueue.add(o,r,s,function(t){t||(i._added=[]),e(t)})):e(a)}))})},n.prototype.add=function(e,n,i){var o=this;_.isFunction(n)&&(i=n,n={}),t.Util.asyncForEach(e,function(t,e){o.addItem(t,n,function(n){!n&&o._keepSynced&&!t._keepSynced&&t.keepSynced(),e(n)})},i||t.Util.noop)},n.prototype.getKeyPath=function(){return this.parent?[this.parent.bucket(),this.parent.id(),this.model.__bucket]:[this.model.__bucket]},n.prototype.remove=function(e,n,i){var o=this,r=this.items,s=this.getKeyPath();_.isFunction(n)&&(i=n,n={}),t.Util.asyncForEach(e,function(e,i){var a,c,u=r.length;for(a=0;u>a;a++)if(r[a].id()==e){c=r[a];break}if(c){if(r.splice(a,1),c.off("changed:",o.updateFn),c.off("deleted:",o.deleteFn),o.set("count",r.length),o.emit("removed:",c,a),c.release(),!(!o.isKeptSynced()||n&&n.nosync)){var h=_.initial(c.getKeyPath());return t.Model.storageQueue.remove(s,h,[c.id()],i),void 0}o._removed.push(e)}i()},i)},n.prototype.keepSynced=function(){this.startSync(),this.map(function(t){t.keepSynced()})},n.prototype.isKeptSynced=function(){return this._keepSynced},n.prototype.toggleSortOrder=function(){this.set("sortOrder","asc"==this.sortOrder?"desc":"asc")},n.prototype.setFormatters=function(t){this._formatters=t,this.each(function(e){e.format(t)})},n.prototype.filtered=function(t){this.filterFn?t(null,this.filter(this.filterFn)):t(null,this.items)},n.prototype.isFiltered=function(t){return this.filterFn?this.filterFn(t):!0},n.prototype.reverse=function(){return this.items.reverse(),this},n.prototype.addPersistedItem=function(e,n){var i=this.getKeyPath(),o=_.initial(e.getKeyPath());t.Model.storageQueue.add(i,o,[e.id()],n)},n.prototype.addItem=function(e,n,i){var o=this;return this.findById(e.id())?i():(this.sortByFn?this.sortedAdd(e):this.items.push(e),this.initItems(e),this.set("count",this.items.length),this.emit("added:",e),this.isKeptSynced()?n&&n.nosync===!0?i():e.isPersisted()?this.addPersistedItem(e,i):e.save(function(n){n||o.addPersistedItem(e,t.Util.noop),i(n)}):(this._added.push(e),i()),void 0)},n.prototype.sortedAdd=function(t){"desc"==this.sortOrder&&this.items.reverse();var e=this.sortedIndex(t,this.sortByFn);return this.items.splice(e,0,t),"desc"==this.sortOrder&&this.items.reverse(),e},n.prototype.startSync=function(){var e=this;this._keepSynced=!0,this.parent&&t.Model.syncManager&&(this.parent.isPersisted()?t.Model.syncManager.startSync(this):this.parent.on("id",function(){t.Model.syncManager.startSync(e)})),this.on("add:",function(n,i){t.Util.asyncForEach(i,function(t,i){e.findById(t)||e.model.findById(n.concat(t),!0,{},function(t,n){n&&e.addItem(n,{nosync:!0},i)})},t.Util.noop)}),this.on("remove:",function(n,i){e.remove(i,!0,t.Util.noop)})},n.prototype.resync=function(t){var e=this,n=[],i=t.slice(0);this.each(function(e){for(var i=e.id(),o=!0,r=0;t.length>r;r++)if(i==t[r]._id){e.set(t[r],{nosync:!0}),o=!1;break}o&&n.push(i)}),this.remove(n,{nosync:!0},function(t){t||e.model.createModels(i,function(t,n){t||e.add(n,{nosync:!0},function(){e.emit("resynced:")})})})},n.prototype.listenToResync=function(){var e=this,n=t.Storage.Queue.makeKey(this.getKeyPath());this.resyncFn=function(t){e.resync(t)},t.Model.storageQueue&&t.Model.storageQueue.on("resync:"+n,this.resyncFn)},n.prototype.endSync=function(){t.Model.syncManager&&t.Model.syncManager.endSync(this),this._keepSynced=!1},n.prototype.initItems=function(t){t=_.isArray(t)?t:[t];for(var e=0,n=t.length;n>e;e++){var i=t[e];i.retain(),i.on("changed:",this.updateFn),i.on("deleted:",this.deleteFn)}},n.prototype.deinitItems=function(e){var n=t.Storage.Queue.makeKey(this.getKeyPath());t.Model.storageQueue&&t.Model.storageQueue.off("resync:"+n,this.resyncFn);for(var i=0,o=e.length;o>i;i++){var r=e[i];r.off("changed:",this.updateFn),r.off("deleted:",this.deleteFn),r.release()}},n}(t.Base);t.Collection=e;var n=["forEach","each","map","reduce","reduceRight","find","detect","pluck","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty","groupBy"];_.each(n,function(t){e.prototype[t]=function(){return _[t].apply(_,[this.items].concat(_.toArray(arguments)))}})})(Gnd||(Gnd={}));var Gnd;(function(t){(function(e){function n(e,n){_.isFunction(e)&&(n=e,e="/");var i,o=function(){var e=location.hash.replace(/^#!?/,"");if(!i||i.url!==e){i&&i.queue.cancel(),i=new p(e,i&&i.nodes||[]);var o=i.index;n(i),o==i.index&&(i.isNotFound=!0,i.queue.end()),i.queue.wait(function(){if(i.isNotFound){if(!i.notFoundFn)return console.log("Undefined route:"+location.hash),void 0;i.index=1,i.initNode("body"),i.notFoundFn.call(i,i);var e=new t.TaskQueue;c(e,i.node())}})}};""===location.hash?e&&(location.hash="!"+e):o(),"onhashchange"in window?window.onhashchange=o:u=setInterval(o,50)}function i(){u&&(clearInterval(u),u=null),"onhashchange"in window&&(window.onhashchange=null)}function o(e){location.hash=e,"onhashchange"in window&&t.$(window).trigger("onhashchange")}function r(t,e,n){return":"===t.charAt(0)?(n[t.replace(":","")]=e,!0):!1}function s(e,n,i){t.Util.asyncForEach(n,function(t,n){t(e,n)},i)}function a(t,e,n){for(var i=e.length-1;i>=n;i--){var o=e[i];o.el||t.append(o.select),t.append(o.exit||o.hide,o.drain,o.leave)}}function c(t,e){t.append(e.select,e.hide,e.before,e.load,e.render,e.enter||e.show,e.after)}var u;e.listen=n,e.stop=i,e.redirect=o;var h=function(t){if(t){var e,n=t.split("&"),i=n.length,o={};for(e=0;i>e;e++){var r=n[e].split("=");o[decodeURIComponent(r[0])]=r[1]?decodeURIComponent(r[1]):""}return o}return{}},d=function(){function t(){this.drained=!1,this.pool=[]}return t.prototype.autorelease=function(){var t=this.pool;_.each(arguments,function(e){_.isArray(e)?t.push.apply(t,e):t.push(e)}),this.drained&&this.drain()},t.prototype.drain=function(){for(var t=0,e=this.pool.length;e>t;t++)this.pool[t].release();this.pool=[],this.drained=!0},t}(),f=t.overload({"Function Array Function":function(t,e,n){return function(i){var o=_.clone(e);o.push(function(){n(i),0===n.length&&i()}),t.apply(null,o)}},"Function Function":function(t,e){return f(t,[],e)},"Function Array":function(e,n){return f(e,n,t.Util.noop)},Function:function(t){return f(t,[])}}),l=function(t){var e,n,i=t.split("?");return e=i[0].split("/"),n=e.length,""===_.last(e)&&n>1&&e.splice(n-1,1),{components:e,query:h(i[1])}},p=function(){function e(e,n){this.nodes=[],this.index=0,this.level=0,this.params={},this.queue=new t.TaskQueue;var i,o,r,s,a=this;for(_.extend(a,l(e)),i=a.components,r=i.length,s=n.length,this.url=e,this.prevNodes=n,o=0;r>o;o++){var c=n[o],u=n[o+1];if(!c||c.component!==i[o]||!(r>s||c.selector!=u.selector||r-1>o))break;a.nodes.push({component:i[o],autoreleasePool:c.autoreleasePool})}for(a.startIndex=o,o=a.startIndex;r>o;o++)a.nodes.push({component:i[o],autoreleasePool:new d})}return e.prototype.get=function(){return t.overload({"String String String":function(t,e,n){return this._get(t,e,{},[],n)},"String String Array String":function(t,e,n,i){return this._get(t,e,{},n,i)},"String String Array Function":function(t,e,n,i){return this._get(t,e,{},n,i)},"String String Function":function(t,e,n){return this._get(t,e,{},[],void 0,n)},"String String Object String":function(t,e,n,i){return this._get(t,e,n,[],i)},"String Function":function(t,e){return this._get(t,"body",{},[],void 0,e)},Function:function(t){return this._get("","body",{},[],void 0,t)}}).apply(this,arguments)},e.prototype._get=function(t,e,n,i,o,r){return this.wantsRedirect||!this.consume(t,this.level)?this:(this.queue.append(this.createRouteTask(this.level,e,n,i,o,r)),this)},e.prototype.createRouteTask=function(t,e,n,i,o,r){var c=this;return function(u){s(c,i,function(){var i=c.node(),s=i.autoreleasePool,h=c.index,d=h===c.components.length;h==c.startIndex&&a(c.queue,c.prevNodes,c.startIndex),c.initNode(e,i),r?(c.enterNode(r,i,h,t,{},s,d),u()):curl([o],function(e){c.enterNode(e,i,h,t,n,s,d),u()})})}},e.prototype.initNode=function(e,n){var i=this;(function(n){n.select=f(function(o){n.el=i.el=t.$(e)[0],o()}),n.selector=e,n.hide=f(function(e){n.el&&t.hide(n.el),e()}),n.show=f(function(e){n.el&&t.show(n.el),e()}),n.drain=f(function(t){n.autoreleasePool.drain(),t()})})(n||this.node())},e.prototype.enterNode=function(t,e,n,i,o,r,s){this.level=i+1,7==arguments.length?t&&t.call(this,r,o):(t&&t.call(this,o),s=r),this.isNotFound=n>=this.index&&!s,!this.isNotFound&&n>this.startIndex&&c(this.queue,e),(this.isNotFound||s)&&this.queue.end()},e.prototype.currentSubPath=function(){for(var t="",e=0,n=this.index;n>e;e++)t+=this.components[e]+"/";return t.length>0&&(t=t.substr(0,t.length-1)),t},e.prototype.consume=function(t,e){var n=this.index;if(t){if(e!=n||n>=this.components.length)return!1;var i=this.components[n];if(!r(t,i,this.params)&&t!==i)return!1}return this.index++,!0},e.prototype.notFound=function(t){this.notFoundFn=t},e.prototype.node=function(){return this.nodes[0>=this.index?0:this.index-1]},e.prototype.isLast=function(){return this.index>=this.components.length},e.prototype.nextComponent=function(){return this.components[this.index]},e.prototype.redirect=function(e,n){e=n?e+"?"+t.serialize(n):e,this.queue.wait(function(){o(e)}),this.wantsRedirect=!0},e.prototype.before=function(t){return this.node().before=f(function(t){t()},t),this},e.prototype.after=function(t){return this.node().after=f(function(t){t()},t),this},e.prototype.enter=function(t){var e=this.node();return e.enter=f(function(n){e.el&&t(e.el,n),1==t.length&&n()}),this},e.prototype.exit=function(t){var e=this.node();return e.exit=f(function(n){e.el&&t(e.el,n),1==t.length&&n()}),this},e.prototype.leave=function(t){return this.node().leave=f(function(t){t()},t),this},e.prototype.render=function(){return t.overload({"String String Object Function":function(t,e,n,i){var o=_.bind(this._render,this);return this.node().render=f(o,[t,e,n],i),this},"String String Function":function(t,e,n){return this.render(t,e,{},n)},"String String":function(e,n){return this.render(e,n,{},t.Util.noop)},"String String Object":function(e,n,i){return this.render(e,n,i,t.Util.noop)},"String Object":function(e,n){return this.render(e,"",n,t.Util.noop)},"String Object Function":function(t,e,n){return this.render(t,"",e,n)},"String Function":function(t,e){return this.render(t,"",{},e)},String:function(e){return this.render(e,t.Util.noop)}}).apply(this,arguments)},e.prototype.load=function(t,e){_.isFunction(t)&&(e=t,t=null);var n=_.bind(this._load,this);return this.node().load=f(n,[t],e),this},e.prototype._render=function(e,n,i,o){function r(e){var n;_.isString(i)?n[i]=a.data:n=_.isObject(i)&&!_.isEmpty(i)?i:_.isObject(a.data)?a.data:{};var r=t.using.template(e)(n);a.el?(a.el.innerHTML=r,s(a.el,o)):o()}function s(e,n){var i=t.$("img",e),o=i.length;n=_.once(n);var r=_.debounce(n,1e3);if(o>0){r();var s=function(){r(),i.off("load",s),o--,0===o&&n()};i.on("load",s)}else n()}var a=this;_.isObject(n)?(o=i,i=n,n=void 0):_.isFunction(n)?(o=n,n=void 0,i=void 0):_.isFunction(i)&&(o=i,i=void 0),o=o||t.Util.noop;var c=["text!"+e];n&&c.push("css!"+n),curl(c,function(t){r(t)})},e.prototype._load=function(t,e){var n,i,o=(this.currentSubPath(),this);null===t&&(t=o.data),_.isArray(t)||(t=[t]);var r=[];for(n=0,i=t.length;i>n;n++)r.push("text!"+t[n]);curl(r,function(){var t=arguments,r=[];for(n=0,i=t.length;i>n;n++)try{r.push(JSON.parse(arguments[n]))}catch(s){console.log("Error parsing data: "+s.name+"::"+s.message)}r=1===r.length?r[0]:r,o.data=r,e&&e()})},e}()})(t.Route||(t.Route={})),t.Route})(Gnd||(Gnd={}));var Gnd;(function(t){var e=function(e){function n(t,i,o){e.call(this),this.children=[],this.selector=t,i&&(i instanceof n?(this.parent=i,i.children.push(this)):o=o||i),_.extend(this,o),this.onShowing=this.onHidding=function(t,e,n){n()}}return __extends(n,e),n.prototype.init=function(e){var n=this;t.Util.fetchTemplate(this.templateUrl,this.cssUrl,function(i,o){i?e(i):(n.template=t.using.template(n.templateStr||o),t.Util.asyncForEach(n.children,function(t,e){n.init(e)},e))})},n.prototype.render=function(e){var n;if(n=this.template?this.template(e):this.html||"<div>",this.fragment=t.$(n)[0],!this.fragment)throw Error("Invalid html:\n"+n);var i=this.parent?this.parent.root:null,o=this.root=this.selector&&t.$(this.selector,i)[0]||document.body;this.style&&t.$(o).css(this.style),o.appendChild(this.fragment),_.each(this.children,function(t){t.render(e)})},n.prototype.clean=function(){this.root&&t.$(this.root).html("")},n.prototype.disable=function(){console.log(this+" does not implement disable")},n.prototype.hide=function(e,n){var i=this;this.root&&this.onHidding(this.root,e,function(){t.$(i.root).hide(),n()})},n.prototype.show=function(e,n){var i=this;this.root&&this.onShowing(this.root,e,function(){t.$(i.root).show(),n()})},n.prototype.destroy=function(){this.clean(),e.prototype.destroy.call(this)},n}(t.Base);t.View=e})(Gnd||(Gnd={}));var Gnd;(function(t){function e(e,n){t.isElement(n)?e.parentNode.replaceChild(n,e):t.$(e).html(n)}function n(t){for(var e=t.trim().split("."),n=0;e.length>n;n++)e[n]=e[n].trim();return e}var i=/^data-/,o=function(e){function n(t,n,i,o){e.call(this),this.contexts=[],this.boundBinders=[],this.formatters={},this.formatters=i||this.formatters,this.binders={bind:r,each:s,show:a,"class":c,event:u},_.extend(this.binders,o),this.pushContext(n),this.boundBinders=this.bindNode(t)}return __extends(n,e),n.prototype.destroy=function(){this.unbind(),e.prototype.destroy.call(this)},n.prototype.unbind=function(t){_.each(t||this.boundBinders,function(t){t.unbind()}),!t&&(this.boundBinders=[])},n.prototype.resolveContext=function(t){for(var e,n=t[0],i=this.contexts.length-1;i>=0;i--)if(e=this.contexts[i][n])return this.resolveKeypath(e,_.rest(t))},n.prototype.pushContext=function(t){this.contexts.push(t)},n.prototype.popContext=function(){this.contexts.pop()},n.prototype.bindNode=function(e){var n=[];if(e.attributes)for(var o=e.attributes,r=0;o.length>r;r++)if(i.test(o[r].name)){var s=o[r].name.replace(i,""),a=o[r].value;if(this.binders[s]){var c=new this.binders[s];c.bind(e,a,this),n.push(c)}}if(e.hasChildNodes())for(var u=_.toArray(e.childNodes),h=0;u.length>h;h++)t.isElement(u[h])&&n.push.apply(n,this.bindNode(u[h]));return n},n.prototype.resolveKeypath=function(t,e){for(var n=0;e.length>n;n++)if(t=t[e[n]],!t)return null;return t},n}(t.Base);t.ViewModel=o;var r=function(){function i(){this.bindings=[],this.attrBindings={},this.attrFormatters={}}return i.re=/((\s*(\w+)\s*\:\s*((\w+\.*)+)\s*(\|\s*(\w+)\s*)?);?)/gi,i.prototype.parse=function(t,e){for(var o,r;o=i.re.exec(t);){var s=o[3];this.attrBindings[s]=n(o[4]),r=e[o[7]],r&&(this.attrFormatters[s]=r)}},i.prototype.createBinding=function(n,i,o){var r=this.attrBindings[n],s=this.attrFormatters[n],a=o.resolveContext(_.initial(r));if(a instanceof t.Base){var c,u=_.rest(r).join("."),h=null,d=function(){return s?s(a.get(u)):a.get(u)};"text"===n?(e(i,d()),c=function(){e(i,d())}):(t.setAttr(i,n,d()),c=function(){t.setAttr(i,n,d())},h=function(){a.set(u,t.getAttr(i,n))}),a.retain(),a.on(u,c),t.$(i).on("change",h),this.bindings.push([a,u,c,h])}else console.log("Warning: not found a valid model: "+r[0])},i.prototype.bind=function(t,e,n){this.parse(e,n.formatters),this.el=t;for(var i in this.attrBindings)this.createBinding(i,t,n)},i.prototype.unbind=function(){var e=this;_.each(this.bindings,function(n){n[0].off(n[1],n[2]),n[0].release(),n[3]&&t.$(e.el).off("change",n[3])})},i}(),s=function(){function e(){this.items=[],this.mappings={}}return e.prototype.bind=function(e,i,o){var r=this,s=i.trim().split(":");if(2!==s.length)return console.log("Warning: syntax error in data-each:"+i),void 0;var a=this.mappings,c=e.nextSibling,u=n(s[0]),h=o.resolveContext(u),d=s[1].trim(),f=this.parent=e.parentNode;if(this.viewModel=o,h instanceof t.Collection){this.collection=h,f.removeChild(e),e.removeAttribute("data-each"),e.removeAttribute("id");var l=function(n,i){var r=e.cloneNode(!0),s=n.id(),c=function(e){e in a||(delete a[s],a[e]=r,t.setAttr(r,"data-item",e))};n.retain(),t.setAttr(r,"data-item",s),a[s]=r,i?f.insertBefore(r,i):f.appendChild(r);var u={};u[d]=n,o.pushContext(u),r["gnd-bindings"]=o.bindNode(r),o.popContext(),n.on("id",c),r["gnd-obj"]=n,r["gnd-listener"]=c},p=function(){h.filtered(function(t,e){_.each(e,function(t){l(t,c)})})},y=function(){r.removeNodes(),p()};y(),this.addedListener=function(t){h.isFiltered(t)&&l(t,c)},this.removedListener=function(t){a[t.id()]&&r.removeNode(t.id())},this.updatedListener=y,h.on("added:",this.addedListener).on("removed:",this.removedListener).on("filterFn sorted: updated:",this.updatedListener)}else console.log("Warning: not found a valid collection: "+s[0])},e.prototype.unbind=function(){this.collection.off("added:",this.addedListener),this.collection.off("removed:",this.removedListener),this.collection.off("filterFn sorted: updated:",this.updatedListener),this.removeNodes()},e.prototype.removeNode=function(t){var e=this.mappings[t],n=e["gnd-obj"];this.viewModel.unbind(e["gnd-bindings"]),n.off("id",e["gnd-listener"]),n.release(),this.parent.removeChild(e),delete this.mappings[t]},e.prototype.removeNodes=function(){for(var t in this.mappings)this.removeNode(t)},e}(),a=function(){function e(){this.bindings=[]}return e.prototype.bind=function(e,i,o){function r(n){(a?!n:n)?t.show(e):t.hide(e)}var s=i.replace("!",""),a=s===i?!1:!0,c=n(s),u=o.resolveContext(_.initial(c));if(u instanceof t.Base){u.retain();var h=_.rest(c).join("."),d=function(t){r(t)};r(u.get(h)),u.on(h,d),this.bindings.push([u,h,d])}else console.log("Warning: not found a valid model: "+i)},e.prototype.unbind=function(){_.each(this.bindings,function(t){t[0].off(t[1],t[2]),t[0].release()})},e}(),c=function(){function e(){this.bindings=[]}return e.prototype.bind=function(e,i,o){function r(){var t=u;for(var n in h)t=_.union(t,a[n]);e.className=t.join(" ")}for(var s=this,a={},c=i.split(";"),u=""===e.className?[]:e.className.split(" "),h={},d=function(e){var a=e.replace("!",""),c=a===e?!1:!0,u=n(a),d=o.resolveContext(_.initial(u));if(d instanceof t.Base){d.retain();var f,l=_.rest(u).join("."),p=c?!d.get(l):d.get(l);p&&(h[e]=e),f=function(t){(c?!t:t)?h[e]=e:delete h[e],r()},d.on(l,f),s.bindings.push([d,l,f])}else console.log("Warning: not found a valid model: "+i)},f=0;c.length>f;f++){var l=c[f].split(":");if(2===l.length){var p=l[0].trim().split(" "),y=l[1].trim();a[y]=[];for(var v=0;p.length>v;v++)a[y].push(p[v].trim());for(var y in a)d(y);r()}else console.log("Warning: Syntax error in "+c[f])}},e.prototype.unbind=function(){_.each(this.bindings,function(t){t[0].off(t[1],t[2]),t[0].release()})},e}(),u=function(){function e(){this.bindings=[]}return e.re=/((\s*(\w+)\s*\:\s*((\w+\.*)+)\s*);?)/gi,e.prototype.parse=function(t){for(var e,i={};e=r.re.exec(t);)i[e[3]]=n(e[4]);return i},e.prototype.bind=function(e,n,i){var o=this,r=this.parse(n);this.el=e;var s=function(n){var s=r[n],a=i.resolveContext(_.initial(s));if(a instanceof t.Base){var c=_.rest(s).join("."),u=a.get(c);if(a.retain(),_.isFunction(u)){var h=function(t){u.call(a,e,t)};t.$(e).on(n,h),o.bindings.push([a,n,h])}else console.log("Warning: the given handler is not a function: "+s)}else console.log("Warning: not found an object instance of Gnd.Base: "+s[0])};for(var a in r)s(a)},e.prototype.unbind=function(){var e=this;_.each(this.bindings,function(n){n[0].release(),t.$(e.el).off(n[1],n[2])})},e}();String.prototype.trim||(String.prototype.trim=t.Util.trim)})(Gnd||(Gnd={})),function(t,e){"object"==typeof exports?t.module.exports=e():"function"==typeof define&&define.amd?define(e):t.returnExports=e()}(this,function(){return Gnd});